<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cap√≠tulo 1 ‚Äî El Dedos, La Milagrosa y unas clases</title>
<meta name="chapter-id" content="cap01" />
<style>
  :root{
    --bg:#0f1014; --panel:#171923; --muted:#a3adc2; --line:#242836;
    --ink:#e9ecf1; --accent:#2c7be5; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Calibri,sans-serif;background:var(--bg);color:var(--ink)}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);background:#0e1017;position:sticky;top:0;z-index:50}
  header h1{font-size:18px;margin:0}
  .muted{color:var(--muted)}
  .chips{display:flex;gap:8px;align-items:center}
  .chip{display:inline-flex;gap:6px;align-items:center;background:#0e1119;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px}
  .btn{appearance:none;border:1px solid var(--line);background:#10131c;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.primary{border-color:transparent;background:var(--accent)}
  .btn.ghost{background:#0d1017}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:260px 1fr;gap:16px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
  nav.tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
  nav.tabs .tab{border:1px solid var(--line);background:#0e1119;padding:8px 10px;border-radius:999px;cursor:pointer}
  nav.tabs .tab.active{background:#1b2351;border-color:#31407a}
  .scene{display:none}
  .scene.active{display:block}
  .inv{display:flex;gap:8px;flex-wrap:wrap}
  .item{border:1px solid var(--line);background:#0f121a;padding:8px 10px;border-radius:10px;cursor:pointer;user-select:none}
  .item.selected{outline:2px solid var(--accent)}
  .shelf{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
  .pistas{display:flex;flex-direction:column;gap:8px;margin-top:6px}
  .pill{display:inline-flex;gap:6px;align-items:center;background:#0e1119;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .rooms{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .room{position:relative;background:#0c1118;border:1px solid var(--line);border-radius:12px;min-height:180px;padding:16px}
  .pickup{display:inline-flex;align-items:center;gap:6px;border:1px dashed #3b4257;background:#0e121b;padding:6px 10px;border-radius:10px;cursor:pointer}
  .pickup:hover{filter:brightness(1.06)}
  .hint{font-size:12px;color:var(--muted);margin-top:8px}
  .hidden{display:none}
  .academy{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .pizarra{position:relative;background:#0c1118;border:1px solid var(--line);border-radius:12px;min-height:220px;padding:16px}
  .pizarra .pista{position:absolute;left:16px;right:16px;bottom:16px;background:rgba(17,24,39,.75);border:1px dashed #3b4257;padding:10px;border-radius:10px}
  .board{background:#0c1118;border:1px solid var(--line);border-radius:12px;padding:12px}
  .board h3{margin:0 0 8px}
  .pool{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .tile{border:1px solid #334155;background:#111827;padding:8px 10px;border-radius:10px;cursor:pointer;user-select:none}
  .tile.selected{outline:2px solid var(--accent)}
  .cols{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .col{background:#0a0e14;border:1px dashed #324055;border-radius:10px;min-height:82px;padding:8px}
  .col h4{margin:0 0 6px;font-size:13px;color:var(--muted)}
  .cell{background:#0d121a;border:1px solid #2a3344;border-radius:8px;min-height:44px;display:flex;align-items:center;justify-content:center;font-weight:600;color:#cbd5e1}
  .cell.filled{background:#101827;border-style:solid}
  .note{font-size:12px;color:var(--muted);margin-top:8px}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0e1119;border:1px solid #27304b;border-radius:10px;padding:8px 12px;color:#dbe5ff;opacity:0;transition:.25s;pointer-events:none}
  .toast.show{opacity:1}

  /* Bar widgets */
  .bar-actions{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
  .bar-box{background:#0c1118;border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:10px}
  .bar-box h3{margin:0 0 8px}
</style>
</head>
<body>
  <header>
    <h1>Cap√≠tulo 1 <span class="muted">‚Äî El Dedos, La Milagrosa y unas clases</span></h1>
    <div class="chips">
      <span class="chip" id="moneyChip">üí∂ <strong id="moneyVal">0</strong> ‚Ç¨</span>
      <button class="btn" id="btnSave1">Guardar</button>
      <button class="btn ghost" id="btnLoad1">Cargar</button>
      <button class="btn primary" id="btnLauncher">Launcher</button>
    </div>
  </header>

  <div class="wrap">
    <nav class="tabs" id="tabs">
      <div class="tab active" data-target="piso">Piso de Juan</div>
      <div class="tab" data-target="bar">Dos Tercios del Quinto</div>
      <div class="tab" data-target="academia">La Milagrosa</div>
      <div class="tab" data-target="angel">Casa de √Ångel</div>
    </nav>

    <div class="grid">
      <aside class="panel">
        <div class="shelf">
          <strong>Inventario</strong>
          <small class="muted" id="invCount"></small>
        </div>
        <div class="inv inventory" id="inventory"></div>
        <hr style="border:0;border-top:1px solid var(--line);margin:12px 0">
        <strong>Pistas</strong>
        <div class="pistas" id="pistas"></div>
      </aside>

      <main>
        <!-- PISO -->
        <section class="scene active panel" id="scene-piso">
          <h2>Habitaci√≥n de Juan</h2>
          <p class="muted">El despertador martillea, el armario amenaza con caerse‚Ä¶ y el suelo es Vietnam de camisas.</p>

          <div class="rooms">
            <div class="room">
              <h3>Mesita de noche</h3>
              <p class="hint">Cosas que sueles olvidar. C√≥gelas antes de salir, anda.</p>
              <div id="pickups-mesita" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
                <span class="pickup" data-item="llaves">üîë Llaves</span>
                <span class="pickup" data-item="cartera">üí≥ Cartera</span>
                <span class="pickup" data-item="gafas">üëì Gafas</span>
              </div>
            </div>

            <div class="room">
              <h3>Escritorio</h3>
              <p class="hint">Papeles, clips, polvo‚Ä¶ y una nota doblada.</p>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
                <span class="pickup" id="pickup-nota">üìù Leer nota</span>
                <span class="pickup" id="pickup-monedero">ü™ô Monedero</span>
              </div>
              <div id="nota-texto" class="pill hidden" style="margin-top:10px">
                <span>üß©</span><span>‚ÄúDudu f√≠a si le caes simp√°tico.‚Äù</span>
              </div>
            </div>
          </div>

          <div class="hint" style="margin-top:10px">Consejo: selecciona objetos en el inventario para usarlos como ‚Äúherramienta‚Äù cuando un hotspot lo pida.</div>
          <div style="display:flex;gap:8px;margin-top:12px;">
            <button class="btn" data-goto="academia" id="goAcademia">Ir a la academia</button>
            <button class="btn ghost" data-goto="bar">Bajar al bar</button>
          </div>
        </section>

        <!-- BAR -->
        <section class="scene panel" id="scene-bar">
          <h2>Dos Tercios del Quinto</h2>
          <p class="muted">El Dudu seca vasos, el Moro cuela aceite y el Nino discute al domin√≥. El Dedos te gui√±a un ojo.</p>

          <div class="bar-box">
            <h3>Barra</h3>
            <div class="bar-actions">
              <button class="btn" id="btnCafe">Pedir caf√© (1‚Ç¨)</button>
              <button class="btn" id="btnPagar">Pagar deuda (1‚Ç¨)</button>
              <button class="btn ghost" id="btnHablar">Hablar con el Dedos</button>
              <button class="btn ghost" id="btnInvitar">Invitar una ronda (2‚Ç¨)</button>
            </div>
            <div id="barEstado" class="pill"><span>üßæ</span><span>Deuda: 0‚Ç¨ ‚Äî Caf√©: ninguno</span></div>
            <div id="barMsg" class="note"></div>
          </div>

          <div style="margin-top:12px"><button class="btn ghost" data-goto="piso">Volver al piso</button></div>
        </section>

        <!-- ACADEMIA -->
        <section class="scene panel" id="scene-academia">
          <h2>Academia La Milagrosa</h2>
          <div class="academy">
            <div class="pizarra" id="pizarra">
              <h3>Pizarra</h3>
              <p class="muted">¬øSe adivina algo bajo el polvo? Prueba con <em>tiza</em> del inventario.</p>
              <div id="pizarraPista" class="pista hidden">
                <strong>Pista:</strong> ‚Äú‚àÇŒ®/‚àÇt ‚âà ‚Ä¶‚Äù ‚Äî algo de fluidos que a Juan le persigue.
              </div>
              <div style="margin-top:10px">
                <span id="pickupTiza" class="pickup"><span>üßº</span><span>Recoger tiza de la mesa</span></span>
              </div>
            </div>

            <div class="board">
              <h3>Cuadra el horario de verano</h3>
              <div class="note">Selecciona una ficha del pool y haz click en el d√≠a. Click de nuevo en la celda para vaciar.</div>
              <div id="pool" class="pool"></div>
              <div class="cols" id="cols">
                <div class="col" data-day="lun"><h4>Lunes</h4><div class="cell" data-slot="lun"></div></div>
                <div class="col" data-day="mar"><h4>Martes</h4><div class="cell" data-slot="mar"></div></div>
                <div class="col" data-day="mie"><h4>Mi√©rcoles</h4><div class="cell" data-slot="mie"></div></div>
                <div class="col" data-day="jue"><h4>Jueves</h4><div class="cell" data-slot="jue"></div></div>
              </div>
              <div class="note">Soluci√≥n: LUN=ESO, MAR=Econ√≥micas, MI√â=Bachillerato, JUE=Recuperaci√≥n.</div>
              <div id="horarioOk" class="pill hidden" style="margin-top:10px"><span>‚úÖ</span> Horario listo. Jaime deja de gimotear.</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" data-goto="angel">Ir a casa de √Ångel</button>
            <button class="btn ghost" data-goto="piso">Volver al piso</button>
          </div>
        </section>

        <!-- CASA DE √ÅNGEL -->
        <section class="scene panel" id="scene-angel">
          <h2>Casa de √Ångel</h2>
          <p class="muted">Un flexo, posters y dudas adolescentes. Juan suelta un consejo y se lleva un CD con PDFs de fluidos.</p>
          <div class="pill"><span>üíø</span> Pista: ‚Äúprueba a acercarte por el chat sin estar delante‚Äù.</div>
          <div style="margin-top:10px"><button class="btn ghost" data-goto="piso">Volver al piso</button></div>
        </section>
      </main>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ===== Estado y utilidades ===== */
const STATE_KEY = 'cap01_state_v4';
let state = loadState() || {
  scene: 'piso',
  money: 0,                     // monedas ‚Ç¨
  flags: {},
  pistas: [],
  inventory: [],                // ['llaves','cartera','gafas','tiza','monedero'...]
  board: { lun:null, mar:null, mie:null, jue:null },
  bar: { coffee:false, debt:0, goodwill:false, invited:false }
};

function saveState(){ try{ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }catch(e){} }
function loadState(){ try{ const raw = localStorage.getItem(STATE_KEY); return raw?JSON.parse(raw):null; }catch(e){ return null; } }
function toast(msg){
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(toast._t); toast._t = setTimeout(()=> el.classList.remove('show'), 1400);
}
function setMoney(v){ state.money = Math.max(0, v|0); document.getElementById('moneyVal').textContent = state.money; saveState(); }
function addMoney(d){ setMoney((state.money|0)+ (d|0)); }

/* ===== Navegaci√≥n ===== */
function showScene(name){
  document.querySelectorAll('.scene').forEach(s=>s.classList.remove('active'));
  document.getElementById('scene-'+name)?.classList.add('active');
  document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.target===name));
  state.scene = name; saveState();
  if (name==='bar') refreshBarUI();
}
function bindNav(){
  document.querySelectorAll('.tab').forEach(tab=> tab.onclick = ()=> showScene(tab.dataset.target));
  document.querySelectorAll('[data-goto]').forEach(b=> b.addEventListener('click', ()=> showScene(b.dataset.goto)));

  // Aviso si sales sin llaves/cartera
  document.getElementById('goAcademia').addEventListener('click', (e)=>{
    const faltan = ['llaves','cartera'].filter(x=>!state.inventory.includes(x));
    if (faltan.length){
      e.preventDefault();
      toast('Te faltan: '+faltan.join(' y '));
      setTimeout(()=> showScene('academia'), 250);
    }
  });
}

/* ===== Inventario / Pistas ===== */
let selectedItem = null;
function refreshInventory(){
  const host = document.getElementById('inventory'); host.innerHTML='';
  state.inventory.forEach(id=>{
    const label = (
      id==='llaves'   ? 'üîë Llaves' :
      id==='cartera'  ? 'üí≥ Cartera' :
      id==='gafas'    ? 'üëì Gafas' :
      id==='tiza'     ? 'üßº Tiza' :
      id==='monedero' ? 'ü™ô Monedero' : 'üéí '+id
    );
    const el = document.createElement('div');
    el.className = 'item' + (selectedItem===id?' selected':'');
    el.dataset.id = id;
    el.textContent = label;
    el.onclick = ()=>{ selectedItem = (selectedItem===id ? null : id); refreshInventory(); };
    host.appendChild(el);
  });
  document.getElementById('invCount').textContent = `${state.inventory.length} obj.`;
}
function addItem(id, silent=false){
  if (!state.inventory.includes(id)){
    state.inventory.push(id);
    // bonus del monedero solo una vez
    if (id==='monedero' && !state.flags.monedero_bonus){ addMoney(2); state.flags.monedero_bonus = true; }
    saveState(); refreshInventory();
    if (!silent) toast('Has recogido: '+(id==='tiza'?'tiza':id));
  }
}
function consumeItem(id){
  const i = state.inventory.indexOf(id);
  if (i>=0){ state.inventory.splice(i,1); if (selectedItem===id) selectedItem=null; saveState(); refreshInventory(); }
}
function addPista(code){
  if (!state.pistas.includes(code)){ state.pistas.push(code); saveState(); renderPistas(); }
}
function renderPistas(){
  const host = document.getElementById('pistas'); host.innerHTML='';
  state.pistas.forEach(p=>{
    const pill = document.createElement('div'); pill.className='pill';
    pill.innerHTML = `<span>üß©</span><span>${
      p==='pista_pizarra' ? 'F√≥rmula revelada en la pizarra.' :
      p==='horario_ok'    ? 'Horario cuadrado.' :
      p==='nota_dudu'     ? 'Dudu puede fiar si le caes bien.' :
      p==='dedos_tip'     ? 'El Dedos te suelta un aviso √∫til.' :
      p==='bar_amigos'    ? 'Te ganaste al bar invitando una ronda.' : p
    }</span>`;
    host.appendChild(pill);
  });
}

/* ===== PISO: pickups ===== */
function initPiso(){
  // Mesita
  document.querySelectorAll('#pickups-mesita .pickup').forEach(el=>{
    const id = el.dataset.item;
    el.classList.toggle('hidden', state.inventory.includes(id));
    el.onclick = ()=>{ addItem(id); el.classList.add('hidden'); };
  });

  // Nota + monedero
  const notaBtn = document.getElementById('pickup-nota');
  const notaTxt = document.getElementById('nota-texto');
  notaTxt.classList.toggle('hidden', !state.pistas.includes('nota_dudu'));
  notaBtn.onclick = ()=>{ notaTxt.classList.remove('hidden'); addPista('nota_dudu'); };

  const monBtn = document.getElementById('pickup-monedero');
  monBtn.classList.toggle('hidden', state.inventory.includes('monedero'));
  monBtn.onclick = ()=>{ addItem('monedero'); monBtn.classList.add('hidden'); };
}

/* ===== BAR: l√≥gica ===== */
function refreshBarUI(){
  // Estado textual
  const est = document.getElementById('barEstado');
  est.innerHTML = `<span>üßæ</span><span>Deuda: ${state.bar.debt}‚Ç¨ ‚Äî Caf√©: ${state.bar.coffee?'tomado':'ninguno'}</span>`;

  // Botones habilitados/inhabilitados
  const cafe = document.getElementById('btnCafe');
  const pagar = document.getElementById('btnPagar');
  const hablar = document.getElementById('btnHablar');
  const inv = document.getElementById('btnInvitar');

  cafe.disabled = state.bar.coffee===true; // solo uno en esta escena
  pagar.disabled = !(state.bar.debt>0 && state.money>=1);
  hablar.disabled = false;
  inv.disabled = state.money<2 || state.bar.invited;

  document.getElementById('moneyVal').textContent = state.money;
}
function initBar(){
  document.getElementById('btnCafe').onclick = ()=>{
    // paga si hay dinero
    if (state.money>=1){
      addMoney(-1);
      state.bar.coffee = true;
      document.getElementById('barMsg').textContent = '‚òï Dudu te sirve un caf√© bien caliente. (-1‚Ç¨)';
      toast('Caf√© pagado');
    } else {
      // fiar solo si tienes la pista de la nota
      if (state.pistas.includes('nota_dudu')){
        state.bar.coffee = true;
        state.bar.debt += 1;
        document.getElementById('barMsg').textContent = '‚òï Dudu resopla pero te f√≠a el caf√©. (Deuda +1‚Ç¨)';
        toast('Te lo f√≠an‚Ä¶ por esta vez.');
      } else {
        document.getElementById('barMsg').textContent = 'Dudu frunce el ce√±o: ‚ÄúAqu√≠ no se f√≠a‚Ä¶ salvo a amigos.‚Äù';
        toast('No tienes dinero y Dudu no f√≠a (a√∫n).');
      }
    }
    saveState(); refreshBarUI();
  };

  document.getElementById('btnPagar').onclick = ()=>{
    if (state.bar.debt>0 && state.money>=1){
      state.bar.debt -= 1;
      addMoney(-1);
      document.getElementById('barMsg').textContent = 'üí∏ Pagas 1‚Ç¨ de tu deuda. Dudu asiente.';
      toast('Deuda pagada (-1‚Ç¨)');
      saveState(); refreshBarUI();
    }
  };

  document.getElementById('btnHablar').onclick = ()=>{
    if (state.bar.coffee && !state.bar.goodwill){
      state.bar.goodwill = true;
      addPista('dedos_tip');
      document.getElementById('barMsg').textContent = 'El Dedos: ‚ÄúOjito con Jaime; le gusta que cuadres los lunes primero.‚Äù';
      toast('El Dedos te sopla algo √∫til.');
    } else {
      document.getElementById('barMsg').textContent = 'El Dedos te cuenta batallitas de Ceuta. Nada clave‚Ä¶ por ahora.';
    }
    saveState(); refreshBarUI();
  };

  document.getElementById('btnInvitar').onclick = ()=>{
    if (state.money>=2 && !state.bar.invited){
      addMoney(-2);
      state.bar.invited = true;
      state.bar.goodwill = true;
      addPista('bar_amigos');
      document.getElementById('barMsg').textContent = 'üçª Invitas una ronda. Medio bar te hace palmas. Reputaci√≥n a tope.';
      toast('Ronda invitada (-2‚Ç¨)');
      saveState(); refreshBarUI();
    }
  };

  refreshBarUI();
}

/* ===== Academia: Pizarra / Tiza ===== */
function initPizarra(){
  const pick = document.getElementById('pickupTiza');
  pick.classList.toggle('hidden', state.inventory.includes('tiza'));
  pick.onclick = ()=>{ addItem('tiza'); pick.classList.add('hidden'); };

  const pizarra = document.getElementById('pizarra');
  const pista = document.getElementById('pizarraPista');
  pista.classList.toggle('hidden', !state.flags.pizarra_revelada);

  pizarra.addEventListener('click', ()=>{
    if (state.flags.pizarra_revelada){ toast('Ya has revelado la pista.'); return; }
    if (selectedItem!=='tiza'){ toast('Selecciona la tiza en el inventario.'); return; }
    pista.classList.remove('hidden');
    state.flags.pizarra_revelada = true;
    addPista('pista_pizarra');
    consumeItem('tiza');
    toast('La tiza revela una f√≥rmula medio borrada‚Ä¶');
    saveState();
  });
}

/* ===== Puzzle horario (click-para-colocar) ===== */
const TILES = [
  {id:'eso', label:'ESO'}, {id:'eco', label:'Econ√≥micas'},
  {id:'bach', label:'Bachillerato'}, {id:'rec', label:'Recuperaci√≥n'}
];
const REQUIRED = { lun:'eso', mar:'eco', mie:'bach', jue:'rec' };
let selectedTile = null;

function renderPool(){
  const pool = document.getElementById('pool'); pool.innerHTML='';
  TILES.forEach(t=>{
    const placed = Object.values(state.board).includes(t.id);
    const el = document.createElement('div');
    el.className = 'tile' + (selectedTile===t.id?' selected':'');
    el.dataset.id = t.id; el.textContent = t.label;
    if (placed) { el.style.opacity='.45'; el.style.pointerEvents='none'; }
    el.onclick = ()=>{ selectedTile = (selectedTile===t.id ? null : t.id); renderPool(); };
    pool.appendChild(el);
  });
}
function bindCells(){
  document.querySelectorAll('.cell').forEach(cell=>{
    cell.onclick = ()=>{
      const day = cell.dataset.slot;
      if (cell.dataset.value){
        const prev = cell.dataset.value;
        cell.dataset.value=''; cell.textContent=''; cell.classList.remove('filled');
        state.board[day] = null;
        selectedTile = prev;
        saveState(); renderPool(); checkSolved(); return;
      }
      if (!selectedTile){ toast('Selecciona una ficha en el pool.'); return; }
      const prevDay = Object.keys(state.board).find(d=> state.board[d]===selectedTile);
      if (prevDay){
        const prevCell = document.querySelector(`.cell[data-slot="${prevDay}"]`);
        if (prevCell){ prevCell.dataset.value=''; prevCell.textContent=''; prevCell.classList.remove('filled'); }
        state.board[prevDay] = null;
      }
      const tile = TILES.find(x=>x.id===selectedTile);
      cell.dataset.value = selectedTile;
      cell.textContent = tile.label;
      cell.classList.add('filled');
      state.board[day] = selectedTile;
      selectedTile = null;
      saveState(); renderPool(); checkSolved();
    };
  });
}
function restoreBoard(){
  ['lun','mar','mie','jue'].forEach(day=>{
    const id = state.board[day], cell = document.querySelector(`.cell[data-slot="${day}"]`);
    if (cell){ cell.dataset.value=''; cell.textContent=''; cell.classList.remove('filled'); }
    if (cell && id){ cell.dataset.value=id; cell.textContent=TILES.find(x=>x.id===id)?.label||id; cell.classList.add('filled'); }
  });
  renderPool(); checkSolved(true);
}
function checkSolved(isRestore=false){
  const ok = ['lun','mar','mie','jue'].every(day=> (state.board[day]||'')===REQUIRED[day]);
  document.getElementById('horarioOk').classList.toggle('hidden', !ok);
  state.flags.horario_resuelto = ok;
  if (ok && !state.pistas.includes('horario_ok')){ addPista('horario_ok'); if (!isRestore) toast('Horario resuelto.'); }
  saveState();
}

/* ===== Guardado/carga (local) ===== */
const persist = {
  saveSlot(slot=1){
    try{ localStorage.setItem(`cap01_slot_${slot}`, JSON.stringify(state)); toast('Guardado en slot '+slot); }
    catch(e){ toast('Error guardando.'); }
  },
  loadSlot(slot=1){
    try{
      const raw = localStorage.getItem(`cap01_slot_${slot}`); if (!raw) return toast('Slot vac√≠o.');
      state = JSON.parse(raw);

      // UI general
      document.getElementById('moneyVal').textContent = state.money||0;
      showScene(state.scene||'piso');
      refreshInventory(); renderPistas();

      // Piso
      document.querySelectorAll('#pickups-mesita .pickup').forEach(el=>{
        const id = el.dataset.item; el.classList.toggle('hidden', state.inventory.includes(id));
      });
      document.getElementById('pickup-monedero').classList.toggle('hidden', state.inventory.includes('monedero'));
      document.getElementById('nota-texto').classList.toggle('hidden', !state.pistas.includes('nota_dudu'));

      // Academia
      document.getElementById('pizarraPista').classList.toggle('hidden', !state.flags?.pizarra_revelada);

      // Puzzle
      restoreBoard();

      // Bar
      refreshBarUI();

      toast('Cargado slot '+slot); saveState();
    }catch(e){ console.error(e); toast('Error cargando.'); }
  }
};

/* ===== Top bar ===== */
function initTopBar(){
  document.getElementById('btnSave1').onclick = ()=> persist.saveSlot(1);
  document.getElementById('btnLoad1').onclick = ()=> persist.loadSlot(1);
  document.getElementById('btnLauncher').onclick = ()=> location.href='index.html';
}

/* ===== Arranque ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('moneyVal').textContent = state.money||0;

  bindNav();
  showScene(state.scene||'piso');

  refreshInventory(); renderPistas();
  initPiso();
  initBar();
  initPizarra();

  renderPool(); bindCells(); restoreBoard();
  initTopBar();
});
</script>
</body>
</html>
