<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cap√≠tulo 1 ‚Äî El Dedos, La Milagrosa y unas clases</title>
  <meta name="chapter-id" content="cap01" />
  <style>
    :root{
      --bg:#0f1014; --panel:#171923; --muted:#a3adc2; --line:#242836;
      --ink:#e9ecf1; --accent:#2c7be5; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Calibri,sans-serif;background:var(--bg);color:var(--ink)}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);background:#0e1017;position:sticky;top:0;z-index:50}
    header h1{font-size:18px;margin:0}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:1px solid var(--line);background:#10131c;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.primary{border-color:transparent;background:var(--accent)}
    .btn.ghost{background:#0d1017}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:260px 1fr;gap:16px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
    nav.tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
    nav.tabs .tab{border:1px solid var(--line);background:#0e1119;padding:8px 10px;border-radius:999px;cursor:pointer}
    nav.tabs .tab.active{background:#1b2351;border-color:#31407a}
    .scene{display:none}
    .scene.active{display:block}
    /* Inventario */
    .inv{display:flex;gap:8px;flex-wrap:wrap}
    .item{border:1px solid var(--line);background:#0f121a;padding:8px 10px;border-radius:10px;cursor:grab}
    .item:active{cursor:grabbing}
    .shelf{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    /* Pistas */
    .pistas{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#0e1119;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    /* Academia: pizarra + puzzle */
    .academy{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .pizarra{position:relative;background:#0c1118;border:1px solid var(--line);border-radius:12px;min-height:220px;padding:16px}
    .pizarra h3{margin:0 0 10px}
    .pizarra .pista{position:absolute;left:16px;right:16px;bottom:16px;background:rgba(17,24,39,.7);border:1px dashed #3b4257;padding:10px;border-radius:10px}
    .hidden{display:none}
    /* Puzzle horario */
    .board{background:#0c1118;border:1px solid var(--line);border-radius:12px;padding:12px}
    .board h3{margin:0 0 8px}
    .pool{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tile{border:1px solid #334155;background:#111827;padding:8px 10px;border-radius:10px;cursor:pointer;user-select:none}
    .tile.selected{outline:2px solid var(--accent)}
    .cols{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .col{background:#0a0e14;border:1px dashed #324055;border-radius:10px;min-height:82px;padding:8px}
    .col h4{margin:0 0 6px;font-size:13px;color:var(--muted)}
    .cell{background:#0d121a;border:1px solid #2a3344;border-radius:8px;min-height:44px;display:flex;align-items:center;justify-content:center;font-weight:600;color:#cbd5e1}
    .cell.filled{background:#101827;border-style:solid}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    /* Pickups */
    .pickup{display:inline-flex;align-items:center;gap:6px;border:1px dashed #3b4257;background:#0e121b;padding:6px 10px;border-radius:10px;cursor:pointer}
    .pickup:hover{filter:brightness(1.1)}
  </style>
</head>
<body>
  <header>
    <h1>Cap√≠tulo 1 <span class="muted">‚Äî El Dedos, La Milagrosa y unas clases</span></h1>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn" id="btnSave1">Guardar (S1)</button>
      <button class="btn ghost" id="btnLoad1">Cargar (L1)</button>
      <button class="btn primary" id="btnLauncher">Launcher</button>
    </div>
  </header>

  <div class="wrap">
    <nav class="tabs" id="tabs">
      <div class="tab active" data-target="piso">Piso de Juan</div>
      <div class="tab" data-target="bar">Dos Tercios del Quinto</div>
      <div class="tab" data-target="academia">La Milagrosa</div>
      <div class="tab" data-target="angel">Casa de √Ångel</div>
    </nav>

    <div class="grid">
      <!-- Lateral: Inventario + Pistas -->
      <aside class="panel">
        <div class="shelf">
          <strong>Inventario</strong>
          <small class="muted" id="invCount"></small>
        </div>
        <div class="inv inventory" id="inventory"></div>
        <hr style="border:0;border-top:1px solid var(--line);margin:12px 0">
        <strong>Pistas</strong>
        <div class="pistas" id="pistas"></div>
      </aside>

      <!-- Escenas -->
      <main>
        <!-- Piso -->
        <section class="scene active panel" id="scene-piso">
          <h2>Habitaci√≥n de Juan</h2>
          <p class="muted">El despertador martillea, el armario amenaza con caerse‚Ä¶ lo de siempre. Puedes salir hacia la academia o pasar por el bar.</p>
          <div style="display:flex;gap:8px;">
            <button class="btn" data-goto="academia">Ir a la academia</button>
            <button class="btn ghost" data-goto="bar">Bajar al bar</button>
          </div>
        </section>

        <!-- Bar -->
        <section class="scene panel" id="scene-bar">
          <h2>Dos Tercios del Quinto</h2>
          <p class="muted">El Dudu seca vasos, el Moro cuela aceite y el Nino discute al domin√≥. Aqu√≠ poco que arrastrar, pero algo de chismer√≠o se pesca.</p>
          <div class="pill"><span>üç∫</span> ‚ÄúTranquilo, Juan ‚Äîdice el Dedos‚Äî, cuida t√∫ la cabeza‚Ä¶‚Äù</div>
          <div style="margin-top:10px"><button class="btn ghost" data-goto="piso">Volver al piso</button></div>
        </section>

        <!-- Academia -->
        <section class="scene panel" id="scene-academia">
          <h2>Academia La Milagrosa</h2>
          <div class="academy">
            <!-- Pizarra (hotspot tiza) -->
            <div class="pizarra"
                 id="pizarra"
                 data-hotspot
                 data-accept="tiza"
                 data-reveal="#pizarraPista"
                 data-flag="pizarra_revelada"
                 data-pista="pista_pizarra"
                 data-consume="tiza"
                 data-toast="La tiza revela una f√≥rmula medio borrada‚Ä¶">
              <h3>Pizarra</h3>
              <p class="muted">¬øSe adivina algo bajo el polvo? Prueba con <em>tiza</em>.</p>
              <div id="pizarraPista" class="pista hidden">
                <strong>Pista:</strong> ‚Äú‚àÇŒ®/‚àÇt ‚âà ‚Ä¶‚Äù ‚Äî algo de fluidos que a Juan le persigue.
              </div>
              <div style="margin-top:10px">
                <span id="pickupTiza" class="pickup"><span>üßº</span><span>Recoger tiza de la mesa</span></span>
              </div>
            </div>

            <!-- Puzzle del horario -->
            <div class="board">
              <h3>Cuadra el horario de verano</h3>
              <div class="note">Coloca las fichas en Lunes‚ÄìJueves. Puedes recolocarlas sin pelearte.</div>
              <div id="pool" class="pool"></div>
              <div class="cols" id="cols">
                <div class="col" data-day="lun">
                  <h4>Lunes</h4>
                  <div class="cell" data-slot="lun"></div>
                </div>
                <div class="col" data-day="mar">
                  <h4>Martes</h4>
                  <div class="cell" data-slot="mar"></div>
                </div>
                <div class="col" data-day="mie">
                  <h4>Mi√©rcoles</h4>
                  <div class="cell" data-slot="mie"></div>
                </div>
                <div class="col" data-day="jue">
                  <h4>Jueves</h4>
                  <div class="cell" data-slot="jue"></div>
                </div>
              </div>
              <div class="note">Soluci√≥n ‚Äúcan√≥nica‚Äù: LUN=ESO, MAR=Econ√≥micas, MI√â=Bachillerato, JUE=Recuperaci√≥n.</div>
              <div id="horarioOk" class="pill hidden" style="margin-top:10px"><span>‚úÖ</span> Horario listo. Jaime deja de gimotear.</div>
            </div>
          </div>

          <div style="margin-top:12px"><button class="btn ghost" data-goto="piso">Volver al piso</button></div>
        </section>

        <!-- Casa de √Ångel -->
        <section class="scene panel" id="scene-angel">
          <h2>Casa de √Ångel</h2>
          <p class="muted">Un flexo, posters y dudas adolescentes. Juan suelta un consejo y se lleva un CD con PDFs de fluidos.</p>
          <div class="pill"><span>üíø</span> Pista: ‚Äúprueba a acercarte por el chat sin estar delante‚Äù.</div>
          <div style="margin-top:10px"><button class="btn ghost" data-goto="piso">Volver al piso</button></div>
        </section>
      </main>
    </div>
  </div>

  <!-- N√∫cleo + remoto -->
  <script src="core/engine.js"></script>
  <script src="core/drag.js"></script>
  <script src="core/hotspots.js"></script>
  <!-- Has creado 'migrations.js' (plural) ‚Üí lo cargamos as√≠ -->
  <script src="core/migrations.js"></script>
  <script src="remote-saves.js"></script>

  <script>
    // ===== Estado y utilidades de este cap√≠tulo =====
    window.flags ||= {};
    window.pistas ||= [];
    window.inventory ||= [];

    // Tiles del puzzle (id estables)
    const TILES = [
      {id:'eso', label:'ESO'},
      {id:'eco', label:'Econ√≥micas'},
      {id:'bach', label:'Bachillerato'},
      {id:'rec', label:'Recuperaci√≥n'}
    ];
    const REQUIRED = { lun:'eso', mar:'eco', mie:'bach', jue:'rec' };
    const boardState = (flags.board_cap01 = flags.board_cap01 || { lun:null, mar:null, mie:null, jue:null });
    const tilePlacement = {}; // tileId -> day

    // ===== UI b√°sico: pesta√±as, inventario, pistas =====
    function initTabs(){
      const tabs = document.getElementById('tabs');
      tabs.querySelectorAll('.tab').forEach(tab=>{
        tab.onclick = ()=>{
          tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          tab.classList.add('active');
          const target = tab.dataset.target;
          showScene(target);
        };
      });
      // Botones goto
      document.querySelectorAll('[data-goto]').forEach(b=>{
        b.addEventListener('click', ()=> showScene(b.dataset.goto));
      });
    }
    function showScene(name){
      document.querySelectorAll('.scene').forEach(s=>s.classList.remove('active'));
      document.getElementById('scene-'+name)?.classList.add('active');
      // Actualiza pesta√±a activa
      document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.target===name));
      // Rebind inventario por si cambia el DOM
      window.migrate?.bindInventory?.();
    }

    // Inventario render
    window.ui = window.ui || {};
    window.ui.refreshInventory = function(){
      const host = document.getElementById('inventory');
      host.innerHTML = '';
      inventory.forEach(it=>{
        const el = document.createElement('div');
        el.className = 'item';
        el.dataset.itemId = (typeof it==='string'? it : it.id);
        el.textContent = iconFor(el.dataset.itemId) + ' ' + niceName(el.dataset.itemId);
        host.appendChild(el);
      });
      document.getElementById('invCount').textContent = `${inventory.length} obj.`;
      // Vincula drag para los items pintados
      window.migrate?.bindInventory?.();
    };
    function iconFor(id){
      if (id==='tiza') return 'üßº';
      if (id==='llave_azul') return 'üîë';
      if (id==='moneda') return 'ü™ô';
      return 'üéí';
    }
    function niceName(id){
      return ({
        tiza:'Tiza',
        llave_azul:'Llave azul',
        moneda:'Moneda'
      })[id] || id;
    }

    // Pistas render
    window.ui.renderPistas = function(){
      const host = document.getElementById('pistas');
      host.innerHTML = '';
      pistas.forEach(p=>{
        const pill = document.createElement('div');
        pill.className = 'pill';
        pill.innerHTML = `<span>üß©</span><span>${prettyPista(p)}</span>`;
        host.appendChild(pill);
      });
    };
    function prettyPista(id){
      return ({
        'pista_pizarra': 'En la pizarra aparece una f√≥rmula medio borrada.',
        'horario_ok': 'Horario cuadrado: LUN=ESO, MAR=Econ√≥micas, MI√â=Bach, JUE=Recuperaci√≥n.'
      })[id] || id;
    }

    // Toast
    window.ui.note = window.ui.note || (msg=>console.log('[NOTE]', msg));

    // ===== Puzzle: horario (click-para-colocar + recolocaci√≥n segura) =====
    function renderPool(){
      const pool = document.getElementById('pool');
      pool.innerHTML = '';
      TILES.forEach(t=>{
        const el = document.createElement('div');
        el.className = 'tile';
        el.dataset.id = t.id;
        el.textContent = t.label;
        // Deshabilitar si ya est√° colocado
        if (tilePlacement[t.id]) {
          el.style.opacity = '.45';
          el.style.pointerEvents = 'none';
        }
        el.addEventListener('click', ()=> selectTile(el));
        pool.appendChild(el);
      });
    }
    let selectedTile = null;
    function selectTile(el){
      document.querySelectorAll('.tile').forEach(t=>t.classList.remove('selected'));
      if (selectedTile===el){ selectedTile=null; return; }
      selectedTile = el;
      el.classList.add('selected');
    }

    function bindCells(){
      document.querySelectorAll('.cell').forEach(cell=>{
        cell.addEventListener('click', ()=>{
          const day = cell.dataset.slot;
          // Quitar si ya hab√≠a
          if (cell.dataset.value){
            const previous = cell.dataset.value;
            // liberar tile
            tilePlacement[previous] = null;
            cell.dataset.value = '';
            cell.textContent = '';
            cell.classList.remove('filled');
            renderPool();
            checkSolved();
            return;
          }
          if (!selectedTile) { window.ui.note('Selecciona una ficha en el pool.'); return; }
          const id = selectedTile.dataset.id;
          // Si estaba en otro d√≠a, limpia ese d√≠a
          const prevDay = tilePlacement[id];
          if (prevDay){
            const prevCell = document.querySelector(`.cell[data-slot="${prevDay}"]`);
            if (prevCell){
              prevCell.dataset.value = '';
              prevCell.textContent = '';
              prevCell.classList.remove('filled');
            }
          }
          // Coloca en el d√≠a actual
          cell.dataset.value = id;
          cell.textContent = TILES.find(x=>x.id===id).label;
          cell.classList.add('filled');
          tilePlacement[id] = day;
          // Desselecciona y repinta pool
          selectedTile.classList.remove('selected');
          selectedTile = null;
          renderPool();
          saveBoardState();
          checkSolved();
        });
      });
    }

    function restoreBoard(){
      // Restaura boardState -> celdas y tilePlacement
      ['lun','mar','mie','jue'].forEach(day=>{
        const id = boardState[day];
        const cell = document.querySelector(`.cell[data-slot="${day}"]`);
        if (cell && id){
          cell.dataset.value = id;
          cell.textContent = TILES.find(x=>x.id===id)?.label || id;
          cell.classList.add('filled');
          tilePlacement[id] = day;
        }
      });
      renderPool();
      checkSolved(true);
    }

    function saveBoardState(){
      ['lun','mar','mie','jue'].forEach(day=>{
        const cell = document.querySelector(`.cell[data-slot="${day}"]`);
        boardState[day] = cell?.dataset?.value || null;
      });
      // Persistimos en flags (via remote-saves tambi√©n se guarda)
      flags.board_cap01 = boardState;
    }

    function checkSolved(isRestore=false){
      const ok = ['lun','mar','mie','jue'].every(day=>{
        const c = document.querySelector(`.cell[data-slot="${day}"]`);
        return (c?.dataset?.value || '') === REQUIRED[day];
      });
      document.getElementById('horarioOk').classList.toggle('hidden', !ok);
      if (ok && !pistas.includes('horario_ok')){
        pistas.push('horario_ok');
        window.ui.renderPistas?.();
        if (!isRestore) window.ui.note('Horario resuelto.');
      }
      flags.horario_resuelto = ok;
    }

    // ===== Pizarra: pickup tiza y restauraci√≥n desde flags =====
    function initTizaPickup(){
      const pick = document.getElementById('pickupTiza');
      const has = inventory.some(x=> (typeof x==='string'?x:x?.id)==='tiza');
      if (has) pick.classList.add('hidden');
      pick.addEventListener('click', ()=>{
        if (!inventory.some(x=> (typeof x==='string'?x:x?.id)==='tiza')){
          inventory.push('tiza');
          window.ui.refreshInventory();
          pick.classList.add('hidden');
          window.ui.note('Has recogido una tiza.');
        }
      });
    }

    // ===== Botones guardar/cargar/launcher =====
    function initTopBar(){
      document.getElementById('btnSave1').onclick = ()=> persist.saveSlot?.(1);
      document.getElementById('btnLoad1').onclick = ()=> persist.loadSlot?.(1);
      document.getElementById('btnLauncher').onclick = ()=> location.href='index.html';
    }

    // ===== Arranque =====
    document.addEventListener('DOMContentLoaded', ()=>{
      initTabs();
      window.ui.refreshInventory();
      window.ui.renderPistas();
      initTopBar();

      // Academia: puzzle + tiza
      renderPool();
      bindCells();
      restoreBoard();
      initTizaPickup();

      // Si ya estaba revelada la pizarra (flags), el migrations.js se encarga de mostrar #pizarraPista
      // Rebind inventario para drag
      window.migrate?.bindInventory?.();
    });
  </script>
  
</body>
</html>
