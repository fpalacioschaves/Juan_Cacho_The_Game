<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="chapter-id" content="cap03"><!-- ej.: cap01, cap12 -->

<!-- Antes de tu script principal del cap√≠tulo: -->
<!-- Si PHP est√° en la misma carpeta, no pongas nada. Si est√° en /juan_cacho/, puedes forzarlo: -->
<!-- <script>window.__API_BASE__ = '/juan_cacho/';</script> -->
 <script src="core/engine.js"></script>
<script src="remote-saves.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juan Cacho ‚Äî Cap√≠tulo 3 (La Milagrosa, fuera de horario)</title>
<style>
  :root{
    --bg:#0f1115;--panel:#171a21;--card:#1f2430;--muted:#aab2c0;--text:#e7ecf3;
    --accent:#7fd1ae;--accent-2:#7fb0d1;--danger:#ff6b6b;--warn:#ffd166;--ok:#06d6a0;
    --shadow:0 8px 30px rgba(0,0,0,.35);--radius:14px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  button{cursor:pointer;border:none;background:var(--accent);color:#0d1b14;padding:.6rem 1rem;border-radius:10px;font-weight:600;transition:.15s}
  button:hover{filter:brightness(1.05)}
  button.ghost{background:transparent;border:1px solid #2a2f3a;color:var(--text)}
  button.secondary{background:var(--accent-2)}
  .wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
  header{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:1rem 1.2rem;background:linear-gradient(180deg,#12151b 0%, #0f1115 100%);border-bottom:1px solid #202531;position:sticky;top:0;z-index:10}
  .brand{display:flex;gap:.75rem;align-items:center}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--ok);box-shadow:0 0 10px var(--ok)}
  .brand h1{margin:0;font-size:1.05rem;letter-spacing:.4px;color:#cfeadf}
  .toolbar{display:flex;gap:.5rem;align-items:center}
  .sel{appearance:none;background:#121722;border:1px solid #263043;color:#d6e3f1;border-radius:10px;padding:.45rem .6rem}
  .content{padding:1.2rem;display:grid;gap:1rem}
  .scene{display:none;background:var(--panel);border:1px solid #222938;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .scene.active{display:grid}
  .scene-head{display:flex;align-items:center;justify-content:space-between;padding:1rem;border-bottom:1px solid #242b38;background:linear-gradient(180deg,#1a1f29,#171b22)}
  .scene-head h2{margin:0;font-size:1.1rem}
  .scene-body{display:grid;gap:1rem;padding:1rem}
  .grid{display:grid;gap:1rem}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:1fr 1fr 1fr}
  .card{background:var(--card);border:1px solid #2a3040;border-radius:12px;padding:1rem;box-shadow:var(--shadow)}
  .subtitle{color:var(--muted);font-size:.9rem;margin:.15rem 0 .4rem}
  .list{display:grid;gap:.5rem}
  .item{display:flex;align-items:center;justify-content:space-between;background:#222735;border:1px solid #2a3040;padding:.6rem .75rem;border-radius:10px}
  .dialog{display:grid;gap:.5rem}
  .dialog .line{background:#1b202b;padding:.6rem .8rem;border-radius:10px;border:1px solid #273044}
  .choices{display:grid;gap:.5rem}
  .choices button{justify-self:start}
  .footer{display:flex;align-items:center;justify-content:space-between;padding:.5rem 1rem;background:#0f1217;border-top:1px solid #202531;gap:.5rem}
  .inventory{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
  .inv-slot{min-width:44px;min-height:44px;border-radius:10px;border:1px dashed #2a2f3a;background:#141821;display:flex;align-items:center;justify-content:center;position:relative}
  .inv-slot .tag{position:absolute;bottom:-6px;right:-6px;background:#253045;border:1px solid #2c3750;color:#b8c7dc;font-size:.65rem;padding:.1rem .35rem;border-radius:999px}
  .hint{color:var(--muted);font-size:.85rem}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:20}
  .overlay.active{display:flex}
  .modal{width:min(900px,92vw);max-height:88vh;overflow:auto;background:var(--panel);border:1px solid #263043;border-radius:16px;box-shadow:var(--shadow);padding:1rem}
  .map{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  .loc{display:flex;align-items:center;justify-content:space-between;background:#1b2130;border:1px solid #2a3144;border-radius:12px;padding:1rem}
  .badgebar{display:flex;flex-wrap:wrap;gap:.4rem}
  .badge{font-size:.78rem;background:#1a2230;border:1px solid #2b3850;color:#cfeadf;border-radius:999px;padding:.15rem .5rem}
  /* Keypad */
  .keypad{display:grid;gap:.5rem;justify-items:center}
  .keypad .screen{width:100%;font:700 1.2rem/1.2rem ui-monospace,SFMono-Regular,Consolas,monospace;background:#0d131b;border:1px solid #2a3244;color:#cfeadf;border-radius:8px;padding:.6rem;text-align:center;letter-spacing:.25rem}
  .keys{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;width:100%}
  .keys button{padding:.7rem 0}
  .keys .wide{grid-column:span 3}
  /* Drop target style */
  .drop{min-height:60px;border:1px dashed #324057;border-radius:10px;background:#151a22;padding:.6rem;display:flex;align-items:center;justify-content:space-between;gap:.5rem}
  .drop.highlight{outline:2px solid #2f6da1}
  @media (max-width:880px){
    .cols-2,.cols-3{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="dot"></div>
      <h1>Juan Cacho ‚Äî Cap√≠tulo 3</h1>
      <span class="pill" id="statusScene">Escena: ‚Äî</span>
      <span class="pill" id="statusHint">Objetivo: entra en La Milagrosa y encuentra el diario.</span>
    </div>
    <div class="toolbar">
      <select id="langSel" class="sel" title="Idioma">
        <option value="es" selected>ES</option>
        <option value="en">EN</option>
      </select>
      <button class="ghost" id="btnPistas">üóíÔ∏è Pistas</button>
      <button class="ghost" id="btnMapa">üó∫Ô∏è Mapa</button>
      <button class="ghost" id="btnSlots">üíæ Guardar/Cargar</button>
      <button class="ghost" id="btnReset">Reiniciar</button>
    </div>
  </header>

  <main class="content">

    <!-- EXTERIOR (inicio) -->
    <section class="scene active" data-scene="exterior">
      <div class="scene-head">
        <h2>Academia La Milagrosa (noche)</h2>
        <span class="hint">Las puertas est√°n cerradas. Pistas a la vista‚Ä¶ si miras bien.</span>
      </div>
      <div class="scene-body grid cols-3">
        <div class="card">
          <h3>Port√≥n principal</h3>
          <div class="list">
            <div class="item"><span>P√≥ster rasgado (horarios)</span><button class="ghost" onclick="actions.inspectPoster()">Examinar</button></div>
            <div class="item"><span>Papelera (notas)</span><button onclick="actions.searchTrash()">Rebuscar</button></div>
            <div class="item"><span>Puerta trasera</span><button class="secondary" onclick="nav.go('puerta')">Ir</button></div>
          </div>
          <p class="hint" id="exteriorHint">Dos pistas combinan el c√≥digo del teclado.</p>
        </div>
        <div class="card">
          <h3>Bajo farola</h3>
          <div class="list">
            <div class="item"><span>Linterna</span><button onclick="actions.getFlashlight()">Coger</button></div>
            <div class="item"><span>Clip</span><button onclick="actions.getClip()">Coger</button></div>
          </div>
          <p class="hint">Nunca sobran las herramientas.</p>
        </div>
        <div class="card">
          <h3>Narrativa</h3>
          <div class="dialog">
            <div class="line">El barrio duerme; la academia, no tanto.</div>
            <div class="line">Recuerdo: ‚Äújueves, despu√©s de las 20:00‚Äù.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- PUERTA TRASERA -->
    <section class="scene" data-scene="puerta">
      <div class="scene-head">
        <h2>Puerta trasera ‚Äî Teclado</h2>
        <span class="hint">Pulsa el teclado y prueba el c√≥digo.</span>
      </div>
      <div class="scene-body grid cols-2">
        <div class="card">
          <h3>Teclado</h3>
          <div class="badgebar" id="doorBadges"></div>
          <div class="choices" style="margin-top:.5rem">
            <button class="secondary" onclick="ui.toggleKeypad(true)">Abrir teclado</button>
          </div>
          <p class="hint" id="doorMsg">Necesitas el c√≥digo. Dos pistas ayudan.</p>
        </div>
        <div class="card">
          <h3>Acciones</h3>
          <div class="list">
            <div class="item"><span>Volver al exterior</span><button onclick="nav.go('exterior')">Atr√°s</button></div>
            <div class="item"><span>Acceder al pasillo</span><button class="secondary" onclick="nav.toHall()">Entrar</button></div>
          </div>
        </div>
      </div>
    </section>

    <!-- PASILLO -->
    <section class="scene" data-scene="pasillo">
      <div class="scene-head">
        <h2>Pasillo (oscuro)</h2>
        <span class="hint">O enciendes la luz o te apa√±as con la linterna.</span>
      </div>
      <div class="scene-body grid cols-3">
        <div class="card">
          <h3>Cuadro el√©ctrico</h3>
          <div class="list">
            <div class="item"><span>Interruptor general</span><button onclick="actions.toggleLights()">Encender/Apagar</button></div>
          </div>
          <p class="hint" id="lightsHint">Ahora mismo est√° apagado.</p>
        </div>
        <div class="card">
          <h3>Oscuridad</h3>
          <div class="drop" id="dropDark">
            <span>Usa algo que d√© luz‚Ä¶</span>
            <span>üí°</span>
          </div>
          <p class="hint">Tambi√©n vale encender el cuadro.</p>
        </div>
        <div class="card">
          <h3>Puertas</h3>
          <div class="list">
            <div class="item"><span>Aula 3</span><button class="secondary" onclick="nav.toAula()">Entrar</button></div>
            <div class="item"><span>Despacho</span><button class="ghost" onclick="nav.toOffice()">Probar</button></div>
          </div>
          <p class="hint">Si todo est√° a oscuras, cuesta moverse.</p>
        </div>
      </div>
    </section>

    <!-- AULA 3 -->
    <section class="scene" data-scene="aula">
      <div class="scene-head">
        <h2>Aula 3 (vac√≠a)</h2>
        <span class="hint">La pizarra guarda m√°s de lo que parece.</span>
      </div>
      <div class="scene-body grid cols-2">
        <div class="card">
          <h3>Mesa del profesor</h3>
          <div class="list">
            <div class="item"><span>Tiza</span><button onclick="actions.getChalk()">Coger</button></div>
            <div class="item"><span>Volver al pasillo</span><button onclick="nav.go('pasillo')">Atr√°s</button></div>
          </div>
          <p class="hint">La tiza sirve‚Ä¶ para la pizarra, claro.</p>
        </div>
        <div class="card">
          <h3>Pizarra</h3>
          <div id="chalkboard" class="drop">
            <span id="chalkText">La superficie est√° limpia (demasiado).</span>
            <span>üßΩ</span>
          </div>
          <p class="hint" id="aulaHint">Arrastra la <b>tiza</b> desde el inventario a la pizarra.</p>
        </div>
      </div>
    </section>

    <!-- DESPACHO -->
    <section class="scene" data-scene="despacho">
      <div class="scene-head">
        <h2>Despacho de la direcci√≥n</h2>
        <span class="hint">El diario tiene una rueda de 3 letras.</span>
      </div>
      <div class="scene-body grid cols-2">
        <div class="card">
          <h3>Diario (candado de letras)</h3>
          <div class="list">
            <div class="item" style="gap:.5rem">
              <span>Combinaci√≥n</span>
              <span>
                <select id="d1"></select>
                <select id="d2"></select>
                <select id="d3"></select>
              </span>
            </div>
            <div class="item">
              <span>Probar</span>
              <button class="secondary" onclick="story.tryDiary()">Abrir</button>
            </div>
          </div>
          <p class="hint" id="diaryHint">Una pista en la pizarra podr√≠a ayudar.</p>
        </div>
        <div class="card">
          <h3>Salida</h3>
          <div class="list">
            <div class="item"><span>Volver al pasillo</span><button onclick="nav.go('pasillo')">Atr√°s</button></div>
            <div class="item"><span>Terminar cap√≠tulo</span><button class="secondary" onclick="nav.finish()">Salir</button></div>
          </div>
          <p class="hint">No te vayas sin la pista del diario.</p>
        </div>
      </div>
    </section>

    <!-- FIN -->
    <section class="scene" data-scene="fin">
      <div class="scene-head">
        <h2>Exterior de La Milagrosa</h2>
        <span class="hint">Una pieza m√°s del puzle encaja.</span>
      </div>
      <div class="scene-body">
        <div class="card">
          <div class="dialog" id="finDialog">
            <div class="line">Guardas el apunte del diario. Algo importante se cruz√≥ entre Nieves, Remedios y la academia.</div>
          </div>
          <p class="hint">Fin del Cap√≠tulo 3. Progreso guardado.</p>
        </div>
      </div>
    </section>

  </main>

  <footer class="footer">
    <div class="inventory" id="inventory" aria-label="Inventario"></div>
    <div class="hint" id="hintFooter">Encuentra el c√≥digo, entra, revela la pista en la pizarra y abre el diario.</div>
  </footer>
</div>

<!-- OVERLAYS -->
<div class="overlay" id="overlayMapa" aria-hidden="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
      <h3 style="margin:0">Mapa</h3>
      <button class="ghost" onclick="ui.toggleMapa(false)">Cerrar</button>
    </div>
    <div class="map">
      <div class="loc"><span class="name">Exterior</span><button class="secondary" onclick="ui.toggleMapa(false); nav.go('exterior')">Ir</button></div>
      <div class="loc"><span class="name">Puerta trasera</span><button id="btnMapPuerta" class="secondary">Ir</button></div>
      <div class="loc"><span class="name">Pasillo</span><button id="btnMapPasillo" class="secondary">Ir</button></div>
      <div class="loc"><span class="name">Aula 3</span><button id="btnMapAula" class="secondary">Ir</button></div>
      <div class="loc"><span class="name">Despacho</span><button id="btnMapDespacho" class="secondary">Ir</button></div>
    </div>
  </div>
</div>

<div class="overlay" id="overlayPistas" aria-hidden="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
      <h3 style="margin:0">Libretita</h3>
      <button class="ghost" onclick="ui.togglePistas(false)">Cerrar</button>
    </div>
    <div id="pistasBox" class="list"></div>
    <div style="margin-top:.75rem;display:flex;gap:.5rem">
      <input id="pistaInput" placeholder="A√±adir nota‚Ä¶" style="flex:1;background:#11161e;border:1px solid #28344a;color:#cfeadf;border-radius:10px;padding:.6rem" />
      <button onclick="ui.addPista()">A√±adir</button>
      <button class="ghost" onclick="ui.clearPistas()">Vaciar</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlaySlots" aria-hidden="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
      <h3 style="margin:0">Guardado / Carga</h3>
      <button class="ghost" onclick="ui.toggleSlots(false)">Cerrar</button>
    </div>
    <div class="list" id="slotsList"></div>
  </div>
</div>

<div class="overlay" id="overlayKeypad" aria-hidden="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
      <h3 style="margin:0">Teclado</h3>
      <button class="ghost" onclick="ui.toggleKeypad(false)">Cerrar</button>
    </div>
    <div class="keypad">
      <div class="screen" id="kps">‚Äî ‚Äî ‚Äî ‚Äî</div>
      <div class="keys">
        <button onclick="door.key('1')">1</button><button onclick="door.key('2')">2</button><button onclick="door.key('3')">3</button>
        <button onclick="door.key('4')">4</button><button onclick="door.key('5')">5</button><button onclick="door.key('6')">6</button>
        <button onclick="door.key('7')">7</button><button onclick="door.key('8')">8</button><button onclick="door.key('9')">9</button>
        <button onclick="door.clear()">Clear</button><button onclick="door.key('0')">0</button><button class="secondary" onclick="door.ok()">OK</button>
        <button class="wide ghost" onclick="ui.note(flags.doorCodeKnown ? 'Pista: J 20:30 ‚Üí 2030' : 'Te faltan pistas.')">Pista</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ==== i18n simple ==== */
const i18n = {
  lang:'es',
  dict:{
    es:{
      poster:'P√≥ster: ‚ÄúJ 20:3_ Aula 3 (repaso)‚Äù. Falta un d√≠gito.',
      trash:'Nota arrugada: ‚Äú_0 3_‚Äù con un subrayado en el 2‚Ä¶',
      codeKnown:'Las dos pistas casan: 2 0 3 0.',
      doorOpen:'¬°Click! La puerta cede.',
      needDoor:'Primero abre la puerta trasera.',
      lightsOn:'Luces encendidas.',
      lightsOff:'Luces apagadas.',
      needLight:'Demasiado oscuro para avanzar.',
      chalkGot:'Tiza al bolsillo.',
      chalkUse:'La tiza revela: ‚ÄúR ‚Äì N ‚Äì M‚Äù.',
      diaryOpen:'El diario se abre. Apuntas lo importante.',
      saved:'Progreso guardado.',
      loaded:'Progreso cargado.',
      slotEmpty:'(vac√≠o)'
    },
    en:{
      poster:'Poster: ‚ÄúThu 20:3_ Room 3 (review)‚Äù. One digit missing.',
      trash:'Crumpled note: ‚Äú_0 3_‚Äù, the 2 is underlined‚Ä¶',
      codeKnown:'Both hints align: 2 0 3 0.',
      doorOpen:'Click! The door unlocks.',
      needDoor:'Open the back door first.',
      lightsOn:'Lights on.',
      lightsOff:'Lights off.',
      needLight:'Too dark to move.',
      chalkGot:'Chalk pocketed.',
      chalkUse:'Chalk reveals: ‚ÄúR ‚Äì N ‚Äì M‚Äù.',
      diaryOpen:'Diary opens. You jot down the key part.',
      saved:'Game saved.',
      loaded:'Game loaded.',
      slotEmpty:'(empty)'
    }
  }
};
function t(k){ return (i18n.dict[i18n.lang]||{})[k]||k; }

/* ==== SFX ==== */
const sfx = {
  ctx:null,
  beep(freq=440,dur=.08,type='triangle',vol=.02){
    try{
      this.ctx = this.ctx || new (window.AudioContext||window.webkitAudioContext)();
      if (!this.ctx || this.ctx.state !== 'running') return; // evita warning en autoplay
      const o=this.ctx.createOscillator(), g=this.ctx.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=vol;
      o.connect(g); g.connect(this.ctx.destination);
      o.start(); o.stop(this.ctx.currentTime+dur);
    }catch(_){}
  },
  click(){this.beep(520,.05,'square',.015)}, ok(){this.beep(660,.08,'sine',.03)},
  err(){this.beep(220,.12,'sawtooth',.03)}, pick(){this.beep(880,.05,'triangle',.02)}
};

/* ==== Estado ==== */
const flags = {
  // Exterior / puerta
  cluePoster:false, clueTrash:false, doorCodeKnown:false,
  doorOpen:false,
  // Pasillo
  lightsOn:false, usedFlashlight:false,
  // Aula
  tizaFound:false, chalkRevealed:false,
  // Diario
  diaryOpened:false, gotClueDiary:false
};
const pistas = [];
const inventory = []; // {id,name,tag,icon}

/* ==== Persistencia ==== */
const persist = {
  save(){ localStorage.setItem('cacho_cap3_auto', JSON.stringify({flags,pistas,inventory,lang:i18n.lang})); ui.note(t('saved')); },
  load(){ const raw=localStorage.getItem('cacho_cap3_auto'); if(!raw) return;
    try{
      const d=JSON.parse(raw)||{};
      Object.assign(flags,d.flags||{});
      pistas.splice(0,pistas.length,...(d.pistas||[]));
      inventory.splice(0,inventory.length,...(d.inventory||[]));
      if(d.lang) i18n.lang=d.lang;
      ui.refreshInventory(); ui.applyLang(); ui.renderPistas(); ui.ensureMapButtons();
      nav.go(nav.current||'exterior');
      door.renderBadges(); actions.updateLightsHint(); aula.renderBoard(); story.populateDials();
      if (sfx.ctx && sfx.ctx.state === 'running') sfx.ok(); // no suena en fr√≠o
      ui.note(t('loaded'));
    }catch(_){}
  },
  saveToSlot(n){
    localStorage.setItem('cacho_cap3_slot_'+n, JSON.stringify({flags,pistas,inventory,lang:i18n.lang}));
    ui.renderSlots(); ui.note(t('saved')); if (sfx.ctx && sfx.ctx.state === 'running') sfx.ok();
  },
  loadFromSlot(n){
    const raw=localStorage.getItem('cacho_cap3_slot_'+n); if(!raw) return;
    const d=JSON.parse(raw)||{};
    Object.assign(flags,d.flags||{});
    pistas.splice(0,pistas.length,...(d.pistas||[]));
    inventory.splice(0,inventory.length,...(d.inventory||[]));
    i18n.lang=d.lang||'es';
    ui.refreshInventory(); ui.applyLang(); ui.renderPistas(); ui.ensureMapButtons();
    nav.go(nav.current||'exterior'); door.renderBadges(); actions.updateLightsHint(); aula.renderBoard(); story.populateDials();
    if (sfx.ctx && sfx.ctx.state === 'running') sfx.ok();
    ui.note(t('loaded'));
  },
  reset(){ localStorage.removeItem('cacho_cap3_auto'); location.reload(); }
};

/* ==== UI ==== */
const ui = {
  say(id,txt){ const el=document.getElementById(id); if(el) el.textContent=txt; },
  note(msg){ this.say('statusHint', msg); },
  setScene(name){ this.say('statusScene', 'Escena: '+name); },
  refreshInventory(){
    const box=document.getElementById('inventory'); if(!box) return; box.innerHTML='';
    inventory.forEach(it=>{
      const slot=document.createElement('div'); slot.className='inv-slot'; slot.dataset.item=it.id; slot.draggable=true;
      slot.title = it.name;
      slot.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', it.id); });
      slot.innerHTML=`<span>${it.icon||'üéí'}</span><span class="tag">${it.tag||''}</span>`;
      box.appendChild(slot);
    });
  },
  addItem(it){ if(!inventory.find(x=>x.id===it.id)){ inventory.push(it); this.refreshInventory(); sfx.pick(); persist.save(); } },
  removeItem(id){ const i=inventory.findIndex(x=>x.id===id); if(i>=0){ inventory.splice(i,1); this.refreshInventory(); persist.save(); } },
  toggleMapa(show){ const o=document.getElementById('overlayMapa'); o.classList.toggle('active', !!show); o.setAttribute('aria-hidden', (!show).toString()); if(show) this.ensureMapButtons(); },
  togglePistas(show){ const o=document.getElementById('overlayPistas'); o.classList.toggle('active', !!show); o.setAttribute('aria-hidden', (!show).toString()); this.renderPistas(); },
  toggleSlots(show){ const o=document.getElementById('overlaySlots'); if(show) this.renderSlots(); o.classList.toggle('active', !!show); o.setAttribute('aria-hidden', (!show).toString()); },
  toggleKeypad(show){ const o=document.getElementById('overlayKeypad'); o.classList.toggle('active', !!show); o.setAttribute('aria-hidden', (!show).toString()); if(show){ door.display(); } },
  ensureMapButtons(){
    const bP=document.getElementById('btnMapPuerta'); if(bP){ bP.onclick=()=>{ ui.toggleMapa(false); nav.go('puerta'); }; }
    const bH=document.getElementById('btnMapPasillo'); if(bH){ bH.onclick=()=>{ ui.toggleMapa(false); nav.go('pasillo'); }; }
    const bA=document.getElementById('btnMapAula'); if(bA){ bA.onclick=()=>{ ui.toggleMapa(false); nav.go('aula'); }; }
    const bD=document.getElementById('btnMapDespacho'); if(bD){ bD.onclick=()=>{ ui.toggleMapa(false); nav.go('despacho'); }; }
  },
  renderPistas(){ const box=document.getElementById('pistasBox'); if(!box) return;
    box.innerHTML = pistas.length? '' : `<div class="hint">Sin notas por ahora.</div>`;
    pistas.slice(-18).forEach((p,i)=>{ const row=document.createElement('div'); row.className='item'; row.innerHTML=`<span>${p}</span><button class="ghost" onclick="ui.delPista(${i})">Borrar</button>`; box.appendChild(row); });
  },
  addPista(){ const inp=document.getElementById('pistaInput'); const v=(inp.value||'').trim(); if(!v) return; pistas.push(v); inp.value=''; this.renderPistas(); persist.save(); sfx.click(); },
  delPista(i){ pistas.splice(i,1); this.renderPistas(); persist.save(); },
  clearPistas(){ pistas.splice(0,pistas.length); this.renderPistas(); persist.save(); },
  renderSlots(){
    const box=document.getElementById('slotsList'); if(!box) return; box.innerHTML='';
    [1,2,3].forEach(n=>{
      const raw=localStorage.getItem('cacho_cap3_slot_'+n); const meta= raw? 'OK' : t('slotEmpty');
      const row=document.createElement('div'); row.className='item';
      row.innerHTML = `<span><b>Slot ${n}</b> ‚Äî ${meta}</span>
        <span><button class="secondary" onclick="persist.saveToSlot(${n})">Guardar</button>
              <button class="ghost" onclick="persist.loadFromSlot(${n})">Cargar</button></span>`;
      box.appendChild(row);
    });
  },
  applyLang(){
    document.getElementById('langSel').value=i18n.lang;
    document.getElementById('exteriorHint').textContent = (i18n.lang==='es'?'Dos pistas combinan el c√≥digo del teclado.':'Two hints combine the keypad code.');
    document.getElementById('doorMsg').textContent = (i18n.lang==='es'?'Necesitas el c√≥digo. Dos pistas ayudan.':'You need the code. Two hints help.');
    document.getElementById('lightsHint').textContent = flags.lightsOn ? t('lightsOn') : (i18n.lang==='es'?'Ahora mismo est√° apagado.':'Currently off.');
    document.getElementById('aulaHint').textContent = (i18n.lang==='es'?'Arrastra la ':'Drag ')+(i18n.lang==='es'?'tiza':'chalk')+(i18n.lang==='es'?' desde el inventario a la pizarra.': ' from inventory onto the board.');
    document.getElementById('diaryHint').textContent = flags.diaryOpened
      ? (i18n.lang==='es'?'Del diario: ‚ÄúR‚ÄìN‚ÄìM‚Äù. Jueves tarde, aula fuera de horario. Colgante ‚ÄúR‚Äù.':'From the diary: ‚ÄúR‚ÄìN‚ÄìM‚Äù. Thursday evening, after hours. Pendant ‚ÄúR‚Äù.')
      : (i18n.lang==='es'?'Una pista en la pizarra podr√≠a ayudar.':'A hint on the board might help.');
  }
};

/* ==== Navegaci√≥n ==== */
const nav = {
  current:'exterior',
  go(scene){
    document.querySelectorAll('.scene').forEach(s=>s.classList.remove('active'));
    const el=document.querySelector(`.scene[data-scene="${scene}"]`); if(el){ el.classList.add('active'); this.current=scene; ui.setScene(sceneNames[scene]||scene); persist.save(); }
    if(scene==='puerta') door.renderBadges();
    if(scene==='pasillo'){ actions.updateLightsHint(); pasillo.bindDrop(); }
    if(scene==='aula'){ aula.bindDrop(); aula.renderBoard(); }
    if(scene==='despacho'){ story.populateDials(); }
  },
  toHall(){
    if(!flags.doorOpen){ ui.note(t('needDoor')); sfx.err(); return; }
    this.go('pasillo');
  },
  toAula(){
    if(!flags.lightsOn && !flags.usedFlashlight){ ui.note(t('needLight')); sfx.err(); return; }
    this.go('aula');
  },
  toOffice(){
    if(!flags.lightsOn && !flags.usedFlashlight){ ui.note(t('needLight')); sfx.err(); return; }
    this.go('despacho');
  },
  finish(){
    if(!flags.diaryOpened || !flags.gotClueDiary){ ui.note('A√∫n te falta revisar el diario.'); sfx.err(); return; }
    this.go('fin'); sfx.ok(); persist.save();
  }
};
const sceneNames = {exterior:'Exterior', puerta:'Puerta', pasillo:'Pasillo', aula:'Aula 3', despacho:'Despacho', fin:'(Fin)'};

/* ==== Acciones ==== */
const actions = {
  inspectPoster(){ if(flags.cluePoster) return;
    flags.cluePoster=true; pistas.push(t('poster')); ui.note(t('poster')); sfx.click(); actions.checkDoorClue();
  },
  searchTrash(){ if(flags.clueTrash) return;
    flags.clueTrash=true; pistas.push(t('trash')); ui.note(t('trash')); sfx.click(); actions.checkDoorClue();
  },
  checkDoorClue(){ if(flags.cluePoster && flags.clueTrash && !flags.doorCodeKnown){ flags.doorCodeKnown=true; pistas.push(t('codeKnown')); ui.note(t('codeKnown')); sfx.ok(); door.renderBadges(); persist.save(); } },
  getFlashlight(){ if(inventory.find(x=>x.id==='linterna')) return; ui.addItem({id:'linterna',name:'Linterna',tag:'üî¶',icon:'üî¶'}); },
  getClip(){ if(inventory.find(x=>x.id==='clip')) return; ui.addItem({id:'clip',name:'Clip',tag:'üìé',icon:'üìé'}); },
  toggleLights(){ flags.lightsOn=!flags.lightsOn; ui.note(flags.lightsOn?t('lightsOn'):t('lightsOff')); sfx.click(); actions.updateLightsHint(); persist.save(); },
  updateLightsHint(){ const el=document.getElementById('lightsHint'); if(el) el.textContent = flags.lightsOn ? t('lightsOn') : (i18n.lang==='es'?'Ahora mismo est√° apagado.':'Currently off.'); },
  getChalk(){ if(flags.tizaFound) return; flags.tizaFound=true; ui.addItem({id:'tiza',name:'Tiza',tag:'üßΩ',icon:'üß±'}); ui.note(t('chalkGot')); sfx.pick(); }
};

/* ==== Puerta / Teclado ==== */
const door = {
  target:'2030',
  input:'',
  display(){ const s=document.getElementById('kps'); s.textContent = this.input.padEnd(4,'-').split('').join(' '); },
  key(n){ if(this.input.length>=4) return; this.input+=n; this.display(); sfx.click(); },
  clear(){ this.input=''; this.display(); sfx.click(); },
  ok(){
    if(this.input.length<4){ sfx.err(); return; }
    if(this.input===this.target){ flags.doorOpen=true; ui.note(t('doorOpen')); sfx.ok(); ui.toggleKeypad(false); door.renderBadges(); persist.save(); }
    else{ sfx.err(); this.clear(); }
  },
  renderBadges(){
    const bar=document.getElementById('doorBadges'); if(!bar) return;
    const tags=[];
    if(flags.cluePoster) tags.push('P√≥ster revisado');
    if(flags.clueTrash) tags.push('Nota encontrada');
    if(flags.doorCodeKnown) tags.push('C√≥digo deducido');
    if(flags.doorOpen) tags.push('Puerta abierta');
    bar.innerHTML = tags.length? tags.map(x=>`<span class="badge">${x}</span>`).join('') : `<span class="hint">Sin pistas a√∫n.</span>`;
    const btnPas=document.getElementById('btnMapPasillo'); if(btnPas) btnPas.disabled = !flags.doorOpen;
  }
};

/* ==== Pasillo (drop linterna) ==== */
const pasillo = {
  bindDrop(){
    const zone=document.getElementById('dropDark'); if(!zone) return;
    zone.ondragover = e=>{ e.preventDefault(); zone.classList.add('highlight'); };
    zone.ondragleave = ()=> zone.classList.remove('highlight');
    zone.ondrop = e=>{
      e.preventDefault(); zone.classList.remove('highlight');
      const id=e.dataTransfer.getData('text/plain');
      if(id==='linterna'){ flags.usedFlashlight=true; ui.note('La linterna abre camino.'); sfx.ok(); persist.save(); }
      else { ui.note('No ayuda aqu√≠.'); sfx.err(); }
    };
  }
};

/* ==== Aula (drop tiza en pizarra) ==== */
const aula = {
  bindDrop(){
    const board=document.getElementById('chalkboard'); if(!board) return;
    board.ondragover = e=>{ e.preventDefault(); board.classList.add('highlight'); };
    board.ondragleave = ()=> board.classList.remove('highlight');
    board.ondrop = e=>{
      e.preventDefault(); board.classList.remove('highlight');
      const id=e.dataTransfer.getData('text/plain');
      if(id==='tiza'){ flags.chalkRevealed=true; ui.removeItem('tiza'); document.getElementById('chalkText').textContent = 'R ‚Äî N ‚Äî M'; ui.note(t('chalkUse')); sfx.ok(); persist.save(); }
      else { ui.note('Eso no deja marca.'); sfx.err(); }
    };
  },
  renderBoard(){
    const t=document.getElementById('chalkText');
    if(!t) return;
    t.textContent = flags.chalkRevealed ? 'R ‚Äî N ‚Äî M' : (i18n.lang==='es'?'La superficie est√° limpia (demasiado).':'Board looks too clean.');
  }
};

/* ==== Historia / Diario ==== */
const story = {
  populateDials(){
    const fill=(id)=>{ const s=document.getElementById(id); if(!s) return; s.innerHTML=''; const A='ABCDEFGHIJKLMNOPQRSTUVWXYZ'; for(let i=0;i<A.length;i++){ const o=document.createElement('option'); o.value=A[i]; o.textContent=A[i]; s.appendChild(o); } };
    fill('d1'); fill('d2'); fill('d3');
    if(flags.diaryOpened){ document.getElementById('d1').value='R'; document.getElementById('d2').value='N'; document.getElementById('d3').value='M'; }
  },
  tryDiary(){
    const a=document.getElementById('d1').value;
    const b=document.getElementById('d2').value;
    const c=document.getElementById('d3').value;

    if(a==='R' && b==='N' && c==='M'){
      const msg = 'Del diario: ‚ÄúR‚ÄìN‚ÄìM‚Äù. Jueves tarde, aula fuera de horario. El colgante ‚ÄúR‚Äù se repite en las notas.';

      flags.diaryOpened = true;
      flags.gotClueDiary = true;
      if(!pistas.find(p=>p.includes('Diario: R‚ÄìN‚ÄìM')))
        pistas.push('Diario: R‚ÄìN‚ÄìM. Jueves, despu√©s de las 20:00; aula fuera de horario; colgante ‚ÄúR‚Äù.');

      const hint = document.getElementById('diaryHint');
      if(hint) hint.textContent = msg;

      const finD = document.getElementById('finDialog');
      if(finD) finD.innerHTML = `<div class="line">${msg}</div>`;

      ui.renderPistas();
      ui.note(t('diaryOpen'));
      sfx.ok();
      persist.save();
    }else{
      if(!flags.chalkRevealed){ ui.note('Sin pista clara, es dif√≠cil acertar.'); }
      else { ui.note('No coincide. Revisa la pizarra.'); }
      sfx.err();
    }
  }
};

/* ==== Gesto del usuario ‚Üí reanudar audio ==== */
window.addEventListener('pointerdown', async () => {
  try{
    sfx.ctx = sfx.ctx || new (window.AudioContext || window.webkitAudioContext)();
    if (sfx.ctx.state === 'suspended') await sfx.ctx.resume();
  }catch(e){}
}, { once:true });

/* ==== Header bindings ==== */
document.getElementById('btnMapa').addEventListener('click', ()=>ui.toggleMapa(true));
document.getElementById('btnPistas').addEventListener('click', ()=>ui.togglePistas(true));
document.getElementById('btnReset').addEventListener('click', ()=>persist.reset());
document.getElementById('btnSlots').addEventListener('click', ()=>ui.toggleSlots(true));
document.getElementById('langSel').addEventListener('change', (e)=>{ i18n.lang=e.target.value; ui.applyLang(); persist.save(); sfx.click(); });

/* ==== Init ==== */
ui.setScene('Exterior');
ui.refreshInventory();
ui.applyLang();
ui.ensureMapButtons();
story.populateDials();
persist.load();

/* Expose globals for inline handlers */
window.flags=flags; window.ui=ui; window.nav=nav; window.actions=actions; window.door=door; window.aula=aula; window.story=story; window.pasillo=pasillo;
</script>
</body>
</html>
