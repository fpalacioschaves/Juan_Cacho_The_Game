<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="chapter-id" content="cap09"><!-- ej.: cap01, cap12 -->

<!-- Antes de tu script principal del cap√≠tulo: -->
<!-- Si PHP est√° en la misma carpeta, no pongas nada. Si est√° en /juan_cacho/, puedes forzarlo: -->
<!-- <script>window.__API_BASE__ = '/juan_cacho/';</script> -->
 <script src="core/engine.js"></script>
<script src="remote-saves.js"></script>
<title>Juan Cacho ‚Äî Cap√≠tulo 9 (Puerto ¬∑ Nave 7)</title>
<style>
  :root{
    --bg:#0f1115;--panel:#171a21;--card:#1f2430;--muted:#aab2c0;--text:#e7ecf3;
    --accent:#7fd1ae;--accent-2:#7fb0d1;--danger:#ff6b6b;--warn:#ffd166;--ok:#06d6a0;
    --shadow:0 8px 30px rgba(0,0,0,.35);--radius:14px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  button{cursor:pointer;border:none;background:var(--accent);color:#0d1b14;padding:.6rem 1rem;border-radius:10px;font-weight:600;transition:.15s}
  button:hover{filter:brightness(1.05)}
  button.ghost{background:transparent;border:1px solid #2a2f3a;color:var(--text)}
  button.secondary{background:var(--accent-2)}
  .wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
  header{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:1rem 1.2rem;background:linear-gradient(180deg,#12151b 0%, #0f1115 100%);border-bottom:1px solid #202531;position:sticky;top:0;z-index:10}
  .brand{display:flex;gap:.75rem;align-items:center}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--ok);box-shadow:0 0 10px var(--ok)}
  .brand h1{margin:0;font-size:1.05rem;letter-spacing:.4px;color:#cfeadf}
  .toolbar{display:flex;gap:.5rem;align-items:center}
  .sel{appearance:none;background:#121722;border:1px solid #263043;color:#d6e3f1;border-radius:10px;padding:.45rem .6rem}
  .content{padding:1.2rem;display:grid;gap:1rem}
  .scene{display:none;background:var(--panel);border:1px solid #222938;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .scene.active{display:grid}
  .scene-head{display:flex;align-items:center;justify-content:space-between;padding:1rem;border-bottom:1px solid #242b38;background:linear-gradient(180deg,#1a1f29,#171b22)}
  .scene-head h2{margin:0;font-size:1.1rem}
  .scene-body{display:grid;gap:1rem;padding:1rem}
  .grid{display:grid;gap:1rem}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:1fr 1fr 1fr}
  .card{background:var(--card);border:1px solid #2a3040;border-radius:12px;padding:1rem;box-shadow:var(--shadow)}
  .subtitle{color:var(--muted);font-size:.9rem;margin:.15rem 0 .4rem}
  .list{display:grid;gap:.5rem}
  .item{display:flex;align-items:center;justify-content:space-between;background:#222735;border:1px solid #2a3040;padding:.6rem .75rem;border-radius:10px}
  .dialog{display:grid;gap:.5rem}
  .dialog .line{background:#1b202b;padding:.6rem .8rem;border-radius:10px;border:1px solid #273044}
  .choices{display:grid;gap:.5rem}
  .choices button{justify-self:start}
  .footer{display:flex;align-items:center;justify-content:space-between;padding:.5rem 1rem;background:#0f1217;border-top:1px solid #202531;gap:.5rem}
  .inventory{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
  .inv-slot{min-width:44px;min-height:44px;border-radius:10px;border:1px dashed #2a2f3a;background:#141821;display:flex;align-items:center;justify-content:center;position:relative}
  .inv-slot .tag{position:absolute;bottom:-6px;right:-6px;background:#253045;border:1px solid #2c3750;color:#b8c7dc;font-size:.65rem;padding:.1rem .35rem;border-radius:999px}
  .hint{color:var(--muted);font-size:.85rem}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:20}
  .overlay.active{display:flex}
  .modal{width:min(900px,92vw);max-height:88vh;overflow:auto;background:var(--panel);border:1px solid #263043;border-radius:16px;box-shadow:var(--shadow);padding:1rem}
  .map{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  .loc{display:flex;align-items:center;justify-content:space-between;background:#1b2130;border:1px solid #2a3144;border-radius:12px;padding:1rem}
  .drop{min-height:58px;border:1px dashed #324057;border-radius:10px;background:#151a22;padding:.6rem;display:flex;align-items:center;justify-content:space-between;gap:.5rem}
  .drop.highlight{outline:2px solid #2f6da1}
  /* keypad num */
  .keyN{display:flex;gap:.4rem;align-items:center}
  .keyN select{background:#0f151f;border:1px solid #2a3244;border-radius:8px;color:#dbe6f4;padding:.4rem .5rem}
  /* patrol */
  .patrol{display:grid;gap:.5rem}
  .bar{height:10px;border-radius:999px;background:#1a2130;border:1px solid #2a3144;overflow:hidden}
  .bar .fill{height:100%;width:0;background:linear-gradient(90deg,#2e8b57,#7fd1ae)}
  .state{font-size:.9rem;color:#b6c5da}
  @media (max-width:880px){ .cols-2,.cols-3{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="dot"></div>
      <h1>Juan Cacho ‚Äî Cap√≠tulo 9</h1>
      <span class="pill" id="statusScene">Escena: ‚Äî</span>
      <span class="pill" id="statusHint">Objetivo: infiltra la Nave 7, abre el contenedor y consigue fotos + placa.</span>
    </div>
    <div class="toolbar">
      <select id="langSel" class="sel" title="Idioma">
        <option value="es" selected>ES</option>
        <option value="en">EN</option>
      </select>
      <button class="ghost" id="btnPistas">üóíÔ∏è Pistas</button>
      <button class="ghost" id="btnMapa">üó∫Ô∏è Mapa</button>
      <button class="ghost" id="btnSlots">üíæ Guardar/Cargar</button>
      <button class="ghost" id="btnReset">Reiniciar</button>
    </div>
  </header>

  <main class="content">
    <!-- MUELLE EXTERIOR -->
    <section class="scene active" data-scene="muelle">
      <div class="scene-head">
        <h2>Muelle ‚Äî Exterior Nave 7</h2>
        <span class="hint" id="muelleHint">Avanza cuando el vigilante est√© de espaldas. 3 pasos.</span>
      </div>
      <div class="scene-body grid cols-3">
        <div class="card">
          <h3>Patrulla</h3>
          <div class="patrol">
            <div id="patrolState" class="state">Vigilante: mirando üì¢</div>
            <div class="bar"><div id="patrolProg" class="fill"></div></div>
            <div class="choices">
              <button class="secondary" onclick="patrol.advance()">Avanzar</button>
              <button class="ghost" onclick="patrol.distract()">Lanzar distracci√≥n</button>
            </div>
            <p class="hint" id="patrolHint">Una tuerca suelta podr√≠a ayudar‚Ä¶</p>
          </div>
        </div>

        <div class="card">
          <h3>Suelo del muelle</h3>
          <div class="dialog" id="dockDialog">
            <div class="line">Entre tablones y √≥xido, algo met√°lico asoma.</div>
          </div>
          <div class="choices">
            <button class="ghost" onclick="actions.pickNut()">Coger tuerca</button>
            <button onclick="nav.toNave()">Ir a la puerta de la nave</button>
          </div>
          <p class="hint">La puerta est√° a tres zancadas.</p>
        </div>

        <div class="card">
          <h3>Panor√°mica</h3>
          <div class="dialog">
            <div class="line">Gr√∫as inm√≥viles. La luna ti√±e de plata el agua.</div>
            <div class="line">‚ÄúNave 7‚Äù pintado a brochazos sobre chapa.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- INTERIOR NAVE -->
    <section class="scene" data-scene="nave">
      <div class="scene-head">
        <h2>Nave 7 ‚Äî Pasillo y taquillas</h2>
        <span class="hint">Necesitas abrir el contenedor 459. Herramientas primero.</span>
      </div>
      <div class="scene-body grid cols-2">
        <div class="card">
          <h3>Taquilla</h3>
          <div class="dialog" id="lockerDialog">
            <div class="line">Una taquilla medio abierta. Algo brilla dentro.</div>
          </div>
          <div class="choices">
            <button class="secondary" onclick="nave.getCutter()">Coger c√∫ter</button>
            <button class="ghost" onclick="nav.go('oficina')">Ir a la oficina</button>
          </div>
          <p class="hint" id="cutterHint">El c√∫ter corta la cinta del contenedor.</p>
        </div>

        <div class="card">
          <h3>Contenedor 459</h3>
          <div id="dropTape" class="drop">
            <span id="tapeText">Cinta gruesa y candado num√©rico.</span>
            <span>üì¶</span>
          </div>
          <div class="keyN" style="margin-top:.6rem">
            <select id="d1"></select>
            <select id="d2"></select>
            <select id="d3"></select>
            <button class="secondary" onclick="box.try()">Abrir</button>
          </div>
          <div class="choices" style="margin-top:.5rem">
            <button class="ghost" onclick="box.photo()">Hacer fotos</button>
          </div>
          <p class="hint" id="boxHint">C√≥digo en el albar√°n de la oficina. Primero corta la cinta.</p>
        </div>
      </div>
    </section>

    <!-- OFICINA -->
    <section class="scene" data-scene="oficina">
      <div class="scene-head">
        <h2>Oficina ‚Äî Mesa y archivadores</h2>
        <span class="hint">Busca el albar√°n y una placa.</span>
      </div>
      <div class="scene-body grid cols-2">
        <div class="card">
          <h3>Mesa</h3>
          <div class="dialog" id="deskDialog">
            <div class="line" id="albaranLine">Papelote arrugado con manchas de caf√©.</div>
          </div>
          <div class="choices">
            <button class="secondary" onclick="office.takeAlbaran()">Revisar albar√°n</button>
            <button class="ghost" onclick="nav.go('nave')">Volver a la nave</button>
          </div>
          <p class="hint" id="albaranHint">Se distingue ‚Äú459 ‚Üí 7 5 2‚Äù.</p>
        </div>
        <div class="card">
          <h3>Archivadores</h3>
          <div class="dialog" id="cabinetDialog">
            <div class="line">Entre carpetas, una placa olvidada.</div>
          </div>
          <div class="choices">
            <button class="ghost" onclick="office.takeBadge()">Coger placa de acceso</button>
          </div>
          <p class="hint">No te har√° invisible, pero abre puertas.</p>
        </div>
      </div>
    </section>

    <!-- FIN -->
    <section class="scene" data-scene="fin">
      <div class="scene-head">
        <h2>Salida del Puerto</h2>
        <span class="hint">Siguiente parada: piso de Nieves.</span>
      </div>
      <div class="scene-body">
        <div class="card">
          <div class="dialog" id="finDialog">
            <div class="line">Guardas las <b>fotos del env√≠o</b> y la <b>placa</b> en la chaqueta.</div>
            <div class="line">El viento del muelle corta, pero la noche empieza a hablar.</div>
          </div>
          <p class="hint">Fin del Cap√≠tulo 9. Progreso guardado.</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="inventory" id="inventory" aria-label="Inventario"></div>
    <div class="hint" id="hintFooter">Muelle: 3 pasos cuando no miran ‚Üí Nave: c√∫ter + c√≥digo 752 ‚Üí Fotos + placa.</div>
  </footer>
</div>

<!-- OVERLAYS -->
<div class="overlay" id="overlayMapa" aria-hidden="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
      <h3 style="margin:0">Mapa</h3>
      <button class="ghost" onclick="ui.toggleMapa(false)">Cerrar</button>
    </div>
    <div class="map">
      <div class="loc"><span class="name">Muelle</span><button class="secondary" onclick="ui.toggleMapa(false); nav.go('muelle')">Ir</button></div>
      <div class="loc"><span class="name">Nave</span><button id="btnMapNave" class="secondary">Ir</button></div>
      <div class="loc"><span class="name">Oficina</span><button id="btnMapOfi" class="secondary">Ir</button></div>
      <div class="loc"><span class="name">Salida (fin)</span><button id="btnMapFin" class="secondary">Ir</button></div>
    </div>
  </div>
</div>

<div class="overlay" id="overlayPistas" aria-hidden="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
      <h3 style="margin:0">Libretita</h3>
      <button class="ghost" onclick="ui.togglePistas(false)">Cerrar</button>
    </div>
    <div id="pistasBox" class="list"></div>
    <div style="margin-top:.75rem;display:flex;gap:.5rem">
      <input id="pistaInput" placeholder="A√±adir nota‚Ä¶" style="flex:1;background:#11161e;border:1px solid #28344a;color:#cfeadf;border-radius:10px;padding:.6rem" />
      <button onclick="ui.addPista()">A√±adir</button>
      <button class="ghost" onclick="ui.clearPistas()">Vaciar</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlaySlots" aria-hidden="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
      <h3 style="margin:0">Guardado / Carga</h3>
      <button class="ghost" onclick="ui.toggleSlots(false)">Cerrar</button>
    </div>
    <div class="list" id="slotsList"></div>
  </div>
</div>

<script>
/* ==== i18n ==== */
const i18n = {
  lang:'es',
  dict:{
    es:{
      // muelle
      watchFront:'Vigilante: mirando üì¢',
      watchBack:'Vigilante: de espaldas üë§',
      stepOk:'Avanzas entre sombras‚Ä¶',
      stepFail:'Te han visto. Vuelta atr√°s.',
      needNut:'Necesitas una tuerca para distraer.',
      nutThrown:'La tuerca rueda y hace ruido. Tienes unos segundos.',
      pickedNut:'Coges una tuerca oxidada.',
      // nave / oficina
      gotCutter:'Obtienes un c√∫ter.',
      needCutter:'Primero corta la cinta.',
      needCode:'Necesitas el c√≥digo del albar√°n.',
      cutOk:'La cinta cede.',
      codeOk:'Clic. Candado abierto.',
      codeBad:'No abre con ese c√≥digo.',
      gotPhotos:'Haces varias fotos n√≠tidas.',
      needOpen:'Abre el contenedor antes de fotografiar.',
      gotAlbaran:'Te quedas el albar√°n: ‚Äú459 ‚Üí 7 5 2‚Äù.',
      gotBadge:'Obtienes la placa de acceso.',
      // fin
      saved:'Progreso guardado.',
      loaded:'Progreso cargado.',
      slotEmpty:'(vac√≠o)'
    },
    en:{
      // dock
      watchFront:'Guard: facing you üì¢',
      watchBack:'Guard: turned away üë§',
      stepOk:'You move in the shadows‚Ä¶',
      stepFail:'Spotted. Back to start.',
      needNut:'You need a nut to distract.',
      nutThrown:'Nut rattles on the floor. Few seconds.',
      pickedNut:'You pick up a rusty nut.',
      // warehouse / office
      gotCutter:'You obtain a box cutter.',
      needCutter:'Cut the tape first.',
      needCode:'You need the waybill code.',
      cutOk:'Tape gives way.',
      codeOk:'Click. Lock opens.',
      codeBad:'That code does not work.',
      gotPhotos:'You take clear photos.',
      needOpen:'Open the container before taking photos.',
      gotAlbaran:'You keep the waybill: ‚Äú459 ‚Üí 7 5 2‚Äù.',
      gotBadge:'You obtain the access badge.',
      // misc
      saved:'Game saved.',
      loaded:'Game loaded.',
      slotEmpty:'(empty)'
    }
  }
};
function t(k){ return (i18n.dict[i18n.lang]||{})[k]||k; }

/* ==== Nombres de escena ==== */
const sceneNames = { muelle:'Muelle', nave:'Nave', oficina:'Oficina', fin:'(Fin)' };

/* ==== SFX ==== */
const sfx = {
  ctx:null,
  beep(freq=440,dur=.08,type='triangle',vol=.02){
    try{
      this.ctx = this.ctx || new (window.AudioContext||window.webkitAudioContext)();
      if (!this.ctx || this.ctx.state !== 'running') return;
      const o=this.ctx.createOscillator(), g=this.ctx.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=vol;
      o.connect(g); g.connect(this.ctx.destination);
      o.start(); o.stop(this.ctx.currentTime+dur);
    }catch(_){}
  },
  click(){this.beep(520,.05,'square',.015)}, ok(){this.beep(660,.08,'sine',.03)},
  err(){this.beep(220,.12,'sawtooth',.03)}, pick(){this.beep(880,.05,'triangle',.02)}
};

/* ==== Estado ==== */
const flags = {
  // muelle
  steps:0, inside:false, haveNut:false, distractUntil:0,
  // nave/box
  haveCutter:false, tapeCut:false, boxOpen:false, havePhotos:false,
  // oficina
  haveAlbaran:false, haveBadge:false
};
const pistas = [];
const inventory = []; // {id,name,tag,icon}

/* ==== Persistencia ==== */
const persist = {
  save(){ localStorage.setItem('cacho_cap9_auto', JSON.stringify({flags,pistas,inventory,lang:i18n.lang})); ui.note(t('saved')); },
  load(){ const raw=localStorage.getItem('cacho_cap9_auto'); if(!raw) return;
    try{
      const d=JSON.parse(raw)||{};
      Object.assign(flags,d.flags||{});
      pistas.splice(0,pistas.length,...(d.pistas||[]));
      inventory.splice(0,inventory.length,...(d.inventory||[]));
      if(d.lang) i18n.lang=d.lang;
      ui.refreshInventory(); ui.applyLang(); ui.renderPistas(); ui.ensureMapButtons();
      nav.go(nav.current|| (flags.inside?'nave':'muelle') ); patrol.sync(); nave.bindDrops(); box.populate();
      if (sfx.ctx && sfx.ctx.state === 'running') sfx.ok();
      ui.note(t('loaded'));
      patrol.updateUI(); nave.refreshTexts();
    }catch(_){}
  },
  saveToSlot(n){
    localStorage.setItem('cacho_cap9_slot_'+n, JSON.stringify({flags,pistas,inventory,lang:i18n.lang}));
    ui.renderSlots(); ui.note(t('saved')); if (sfx.ctx && sfx.ctx.state === 'running') sfx.ok();
  },
  loadFromSlot(n){
    const raw=localStorage.getItem('cacho_cap9_slot_'+n); if(!raw) return;
    const d=JSON.parse(raw)||{};
    Object.assign(flags,d.flags||{});
    pistas.splice(0,pistas.length,...(d.pistas||[]));
    inventory.splice(0,inventory.length,...(d.inventory||[]));
    i18n.lang=d.lang||'es';
    ui.refreshInventory(); ui.applyLang(); ui.renderPistas(); ui.ensureMapButtons();
    nav.go(nav.current|| (flags.inside?'nave':'muelle') ); patrol.sync(); nave.bindDrops(); box.populate();
    if (sfx.ctx && sfx.ctx.state === 'running') sfx.ok();
    patrol.updateUI(); nave.refreshTexts();
    ui.note(t('loaded'));
  },
  reset(){ localStorage.removeItem('cacho_cap9_auto'); location.reload(); }
};

/* ==== UI ==== */
const ui = {
  say(id,txt){ const el=document.getElementById(id); if(el) el.innerHTML=txt; },
  note(msg){ this.say('statusHint', msg); },
  setScene(name){ this.say('statusScene', 'Escena: '+name); },
  refreshInventory(){
    const box=document.getElementById('inventory'); if(!box) return; box.innerHTML='';
    inventory.forEach(it=>{
      const slot=document.createElement('div'); slot.className='inv-slot'; slot.dataset.item=it.id; slot.draggable=true;
      slot.title = it.name;
      slot.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', it.id); });
      slot.innerHTML=`<span>${it.icon||'üéí'}</span><span class="tag">${it.tag||''}</span>`;
      box.appendChild(slot);
    });
  },
  addItem(it){ if(!inventory.find(x=>x.id===it.id)){ inventory.push(it); this.refreshInventory(); sfx.pick(); persist.save(); } },
  removeItem(id){ const i=inventory.findIndex(x=>x.id===id); if(i>=0){ inventory.splice(i,1); this.refreshInventory(); persist.save(); } },
  toggleMapa(show){ const o=document.getElementById('overlayMapa'); o.classList.toggle('active', !!show); o.setAttribute('aria-hidden', (!show).toString()); if(show) this.ensureMapButtons(); },
  togglePistas(show){ const o=document.getElementById('overlayPistas'); o.classList.toggle('active', !!show); o.setAttribute('aria-hidden', (!show).toString()); this.renderPistas(); },
  toggleSlots(show){ const o=document.getElementById('overlaySlots'); if(show) this.renderSlots(); o.classList.toggle('active', !!show); o.setAttribute('aria-hidden', (!show).toString()); },
  ensureMapButtons(){
    const b1=document.getElementById('btnMapNave'); if(b1){ b1.onclick=()=>{ ui.toggleMapa(false); nav.toNave(); }; }
    const b2=document.getElementById('btnMapOfi'); if(b2){ b2.onclick=()=>{ ui.toggleMapa(false); nav.go('oficina'); }; }
    const b3=document.getElementById('btnMapFin'); if(b3){ b3.onclick=()=>{ ui.toggleMapa(false); nav.finish(); }; }
  },
  renderPistas(){ const box=document.getElementById('pistasBox'); if(!box) return;
    box.innerHTML = pistas.length? '' : `<div class="hint">Sin notas por ahora.</div>`;
    pistas.slice(-18).forEach((p,i)=>{ const row=document.createElement('div'); row.className='item'; row.innerHTML=`<span>${p}</span><button class="ghost" onclick="ui.delPista(${i})">Borrar</button>`; box.appendChild(row); });
  },
  addPista(){ const inp=document.getElementById('pistaInput'); const v=(inp.value||'').trim(); if(!v) return; pistas.push(v); inp.value=''; this.renderPistas(); persist.save(); sfx.click(); },
  delPista(i){ pistas.splice(i,1); this.renderPistas(); persist.save(); },
  clearPistas(){ pistas.splice(0,pistas.length); this.renderPistas(); persist.save(); },
  renderSlots(){
    const box=document.getElementById('slotsList'); if(!box) return; box.innerHTML='';
    [1,2,3].forEach(n=>{
      const raw=localStorage.getItem('cacho_cap9_slot_'+n); const meta= raw? 'OK' : t('slotEmpty');
      const row=document.createElement('div'); row.className='item';
      row.innerHTML = `<span><b>Slot ${n}</b> ‚Äî ${meta}</span>
        <span><button class="secondary" onclick="persist.saveToSlot(${n})">Guardar</button>
              <button class="ghost" onclick="persist.loadFromSlot(${n})">Cargar</button></span>`;
      box.appendChild(row);
    });
  },
  applyLang(){
    document.getElementById('langSel').value=i18n.lang;
    document.getElementById('muelleHint').textContent = (i18n.lang==='es'?'Avanza cuando el vigilante est√© de espaldas. 3 pasos.':'Move when the guard turns away. 3 steps.');
    document.getElementById('cutterHint').textContent = (i18n.lang==='es'?'El c√∫ter corta la cinta del contenedor.':'The box cutter cuts the container tape.');
    document.getElementById('boxHint').textContent = (i18n.lang==='es'?'C√≥digo en el albar√°n de la oficina. Primero corta la cinta.':'Code is in the office waybill. Cut tape first.');
    patrol.updateUI();
  }
};

/* ==== Navegaci√≥n ==== */
const nav = {
  current:'muelle',
  go(scene){
    document.querySelectorAll('.scene').forEach(s=>s.classList.remove('active'));
    const el=document.querySelector(`.scene[data-scene="${scene}"]`); if(el){ el.classList.add('active'); this.current=scene; ui.setScene(sceneNames[scene]||scene); persist.save(); }
    if(scene==='muelle'){ patrol.start(); }
    else { patrol.stop(); }
    if(scene==='nave'){ nave.bindDrops(); box.populate(); }
  },
  toNave(){
    if(!flags.inside){
      ui.note(i18n.lang==='es'?'Ac√©rcate sin que te vean (3 pasos).':'Get close unseen (3 steps).'); sfx.err(); return;
    }
    nav.go('nave');
  },
  finish(){
    if(!(flags.havePhotos && flags.haveBadge || flags.havePhotos && inventory.find(i=>i.id==='badge'))){
      ui.note(i18n.lang==='es'?'A√∫n te falta algo (fotos y/o placa).':'Still missing something (photos and/or badge).'); sfx.err(); return;
    }
    nav.go('fin'); sfx.ok(); persist.save();
  }
};

/* ==== Acciones generales ==== */
const actions = {
  pickNut(){
    if(flags.haveNut) return;
    flags.haveNut=true;
    ui.addItem({id:'tuerca',name:'Tuerca',tag:'‚Ä¢',icon:'üî©'});
    ui.note(t('pickedNut')); sfx.pick();
  }
};

/* ==== Muelle / Patrulla ==== */
const patrol = {
  timer:null, back:false, // back=true => de espaldas (seguro)
  start(){
    this.stop();
    this.timer = setInterval(()=>{
      // si distracci√≥n activa, forzar de espaldas
      const now=Date.now();
      if(now < flags.distractUntil){ this.back=true; }
      else { this.back = !this.back; }
      this.updateUI();
    }, 1600);
    this.updateUI();
  },
  stop(){ if(this.timer){ clearInterval(this.timer); this.timer=null; } },
  sync(){ /* no-op; kept for symmetry */ },
  updateUI(){
    const st=document.getElementById('patrolState');
    if(!st) return;
    st.textContent = this.back ? t('watchBack') : t('watchFront');
    const prog=document.getElementById('patrolProg');
    if(prog) prog.style.width = Math.min(flags.steps,3)/3*100 + '%';
  },
  advance(){
    const now=Date.now();
    const safe = this.back || (now < flags.distractUntil);
    if(safe){
      flags.steps = Math.min(flags.steps+1,3);
      ui.note(t('stepOk')); sfx.click();
      this.updateUI();
      if(flags.steps>=3){
        flags.inside=true;
        ui.note(i18n.lang==='es'?'Ya est√°s junto a la puerta.':'You are at the door.');
        sfx.ok(); persist.save();
      }
    }else{
      flags.steps=0; ui.note(t('stepFail')); sfx.err(); this.updateUI();
    }
  },
  distract(){
    if(!inventory.find(x=>x.id==='tuerca')){ ui.note(t('needNut')); sfx.err(); return; }
    // consumir tuerca
    ui.removeItem('tuerca'); flags.haveNut=false;
    flags.distractUntil = Date.now()+4500;
    ui.note(t('nutThrown')); sfx.click(); this.updateUI();
  }
};

/* ==== NAVE ==== */
const nave = {
  bindDrops(){
    const dz=document.getElementById('dropTape'); if(!dz) return;
    dz.ondragover = e=>{ e.preventDefault(); dz.classList.add('highlight'); };
    dz.ondragleave = ()=> dz.classList.remove('highlight');
    dz.ondrop = e=>{
      e.preventDefault(); dz.classList.remove('highlight');
      const id=e.dataTransfer.getData('text/plain');
      if(id==='cutter'){
        if(!flags.tapeCut){
          flags.tapeCut=true;
          ui.say('tapeText', i18n.lang==='es'?'Cinta cortada. Queda el candado.':'Tape cut. Lock remains.');
          ui.note(t('cutOk')); sfx.ok(); persist.save();
        }
      } else {
        ui.note(t('needCutter')); sfx.err();
      }
    };
  },
  getCutter(){
    if(flags.haveCutter) return;
    flags.haveCutter=true;
    ui.addItem({id:'cutter',name:'C√∫ter',tag:'‚úÇ',icon:'üî™'});
    ui.note(t('gotCutter')); sfx.pick();
  },
  refreshTexts(){
    if(flags.tapeCut) ui.say('tapeText', i18n.lang==='es'?'Cinta cortada. Candado a la vista.':'Tape cut. Lock visible.');
    if(flags.haveAlbaran) document.getElementById('albaranHint').textContent = (i18n.lang==='es'?'C√≥digo: 7 5 2.':'Code: 7 5 2.');
  }
};

/* ==== OFICINA ==== */
const office = {
  takeAlbaran(){
    if(flags.haveAlbaran) return;
    flags.haveAlbaran=true;
    ui.addItem({id:'albaran',name:'Albar√°n 459',tag:'752',icon:'üìÑ'});
    if(!pistas.find(p=>p.includes('752'))) pistas.push('Cont.459 ‚Üí 7 5 2');
    ui.renderPistas(); ui.note(t('gotAlbaran')); sfx.pick();
    ui.say('albaranLine', (i18n.lang==='es'?'Albar√°n le√≠do: 459 ‚Üí 7 5 2.':'Waybill read: 459 ‚Üí 7 5 2.'));
  },
  takeBadge(){
    if(flags.haveBadge || inventory.find(i=>i.id==='badge')) return;
    flags.haveBadge=true;
    ui.addItem({id:'badge',name:'Placa de acceso',tag:'ID',icon:'ü™™'});
    ui.note(t('gotBadge')); sfx.pick();
  }
};

/* ==== Caja / Contenedor ==== */
const box = {
  code:['7','5','2'],
  populate(){
    const fill=(id)=>{ const s=document.getElementById(id); if(!s) return; s.innerHTML=''; for(let i=0;i<=9;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=String(i); s.appendChild(o);} };
    fill('d1'); fill('d2'); fill('d3');
    if(flags.boxOpen){ document.getElementById('d1').value='7'; document.getElementById('d2').value='5'; document.getElementById('d3').value='2'; }
  },
  try(){
    if(!flags.tapeCut){ ui.note(t('needCutter')); sfx.err(); return; }
    if(!flags.haveAlbaran){ ui.note(t('needCode')); sfx.err(); return; }
    const a=document.getElementById('d1').value;
    const b=document.getElementById('d2').value;
    const c=document.getElementById('d3').value;
    if(a===this.code[0] && b===this.code[1] && c===this.code[2]){
      if(!flags.boxOpen){ flags.boxOpen=true; sfx.ok(); ui.note(t('codeOk')); persist.save(); }
    } else { ui.note(t('codeBad')); sfx.err(); }
  },
  photo(){
    if(!flags.boxOpen){ ui.note(t('needOpen')); sfx.err(); return; }
    if(flags.havePhotos) { sfx.click(); return; }
    flags.havePhotos=true;
    ui.addItem({id:'fotos',name:'Fotos del env√≠o',tag:'üì∑',icon:'üì∑'});
    ui.note(t('gotPhotos')); sfx.ok(); persist.save();
  }
};

/* ==== Importar del Cap.8 si no hay guardado del 9 ==== */
function importFromCap8(){
  try{
    const raw=localStorage.getItem('cacho_cap8_auto'); if(!raw) return;
    const d=JSON.parse(raw)||{}; const inv=(d.inventory||[]);
    ['carpetaR','mapaPuerto','cardCafe','llaveSotano'].forEach(id=>{
      const it = inv.find(x=>x.id===id);
      if(it && !inventory.find(y=>y.id===id)){ ui.addItem(it); }
    });
    // pista de Nave 7
    if(!pistas.find(p=>p.toLowerCase().includes('nave 7'))) pistas.push('Puerto ‚Äî Nave 7');
    ui.renderPistas();
  }catch(_){}
}

/* ==== Header bindings ==== */
document.getElementById('btnMapa').addEventListener('click', ()=>ui.toggleMapa(true));
document.getElementById('btnPistas').addEventListener('click', ()=>ui.togglePistas(true));
document.getElementById('btnReset').addEventListener('click', ()=>persist.reset());
document.getElementById('btnSlots').addEventListener('click', ()=>ui.toggleSlots(true));
document.getElementById('langSel').addEventListener('change', (e)=>{ i18n.lang=e.target.value; ui.applyLang(); persist.save(); sfx.click(); });

/* ==== Audio unlock ==== */
window.addEventListener('pointerdown', async () => {
  try{
    sfx.ctx = sfx.ctx || new (window.AudioContext || window.webkitAudioContext)();
    if (sfx.ctx.state === 'suspended') await sfx.ctx.resume();
  }catch(e){}
}, { once:true });

/* ==== Init ==== */
ui.setScene('Muelle');
ui.refreshInventory();
ui.applyLang();
ui.ensureMapButtons();
patrol.start();
nave.bindDrops();
box.populate();

// Si NO hay guardado previo del cap.9, importamos del cap.8
if(!localStorage.getItem('cacho_cap9_auto')) importFromCap8();

// Y por √∫ltimo, si existe guardado del 9, cargarlo
persist.load();

/* ==== Navegaci√≥n habilitada por progreso ==== */
window.addEventListener('visibilitychange', ()=>{ if(document.hidden) patrol.stop(); else if(nav.current==='muelle') patrol.start(); });

/* ==== Hooks de mapa ==== */
document.getElementById('btnMapNave')?.addEventListener('click', ()=>{ ui.toggleMapa(false); nav.toNave(); });
document.getElementById('btnMapOfi')?.addEventListener('click', ()=>{ ui.toggleMapa(false); nav.go('oficina'); });
document.getElementById('btnMapFin')?.addEventListener('click', ()=>{ ui.toggleMapa(false); nav.finish(); });

/* Export globals (para depurar) */
window.flags=flags; window.ui=ui; window.nav=nav; window.actions=actions;
window.patrol=patrol; window.nave=nave; window.office=office; window.box=box; window.persist=persist;
</script>
</body>
</html>
