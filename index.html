<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Juan Cacho — Launcher</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Calibri,sans-serif;background:#0f1014;color:#e9ecf1;display:flex;min-height:100vh}
    .wrap{margin:auto;max-width:960px;width:100%;padding:24px}
    h1{margin:0 0 8px}
    .sub{opacity:.8;margin:0 0 24px}
    .panel{background:#171923;border:1px solid #242836;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{flex:1 1 260px;background:#0f1118;border:1px solid #232739;border-radius:14px;padding:16px}
    button{appearance:none;background:#2c7be5;border:0;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button.secondary{background:#323645;color:#e9ecf1}
    button:disabled{opacity:.6;cursor:not-allowed}
    select, input[type="text"]{width:100%;background:#10121a;color:#e9ecf1;border:1px solid #2a2f40;border-radius:10px;padding:10px}
    .meta{font-size:12px;opacity:.7;margin-top:8px;word-break:break-all}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:10px}
    .badge{display:inline-block;font-size:12px;padding:2px 8px;border:1px solid #2a2f40;border-radius:999px;background:#141723}
    .ok{color:#6ee7a2}.warn{color:#facc15}.err{color:#f87171}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Juan Cacho</h1>
    <p class="sub">Aventura point-and-click — Launcher</p>

    <div class="panel">
      <div class="row">
        <div class="card">
          <h3>Partida</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btn-continue" disabled>Continuar</button>
            <button id="btn-new">Nueva partida</button>
            <button id="btn-select" class="secondary">Seleccionar capítulo…</button>
          </div>
          <div id="latestInfo" class="meta"></div>
        </div>

        <div class="card">
          <h3>Usuario</h3>
          <div id="userBox" class="meta"></div>
          <button id="btn-new-id" class="secondary" title="Generar un ID nuevo (vacía tus partidas locales)">Nuevo ID</button>
        </div>

        <div class="card" style="flex:1 1 100%">
          <h3>Capítulos</h3>
          <div class="list" id="chapters"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Utilidades mínimas
    function getUserId(){
      let id = localStorage.getItem('cacho_user');
      if(!id){
        const raw = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
        id = 'u_'+String(raw).replace(/[^a-z0-9]/gi,'').slice(0,24);
        localStorage.setItem('cacho_user', id);
      }
      return id;
    }
    const USER_ID = getUserId();

    async function apiLatest(){
      try{
        const r = await fetch('latest.php?user_id=' + encodeURIComponent(USER_ID));
        if(!r.ok) return null;
        const j = await r.json();
        return j.latest || null;
      }catch(_){ return null; }
    }

    function openChapter(num){
      const pad = String(num).padStart(2,'0');
      location.href = `capitulo${num}.html`; // si tus nombres son capitulo01.html etc, ajusta aquí:
      // location.href = `capitulo${pad}.html`;
    }

    // UI
    const elUser = document.getElementById('userBox');
    const btnContinue = document.getElementById('btn-continue');
    const btnNew = document.getElementById('btn-new');
    const btnSelect = document.getElementById('btn-select');
    const latestInfo = document.getElementById('latestInfo');
    const chapters = document.getElementById('chapters');
    const btnNewId = document.getElementById('btn-new-id');

    elUser.innerHTML = `
      <div><span class="badge">USER_ID</span> ${USER_ID}</div>
      <div style="margin-top:6px">Las partidas se guardan por <em>usuario</em> y capítulo.</div>
    `;

    btnNewId.onclick = ()=>{
      if(!confirm('Esto generará un nuevo USER_ID y no verás tus partidas anteriores en este navegador. ¿Continuar?')) return;
      localStorage.removeItem('cacho_user');
      location.reload();
    };

    // Pinta tarjetas de capítulos 1..12
    for(let i=1;i<=12;i++){
      const card = document.createElement('div');
      card.className = 'card';
      const pad = String(i).padStart(2,'0');
      card.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div><strong>Capítulo ${i}</strong></div>
          <button data-go="${i}">Jugar</button>
        </div>
        <div class="meta">Archivo: <code>capitulo${i}.html</code></div>
      `;
      card.querySelector('button').onclick = ()=> openChapter(i);
      chapters.appendChild(card);
    }

    btnNew.onclick = ()=> openChapter(1);

    btnSelect.onclick = ()=>{
      const to = prompt('¿A qué capítulo saltamos? (1-12)', '1');
      const n = parseInt(to,10);
      if(!n || n<1 || n>12) return;
      openChapter(n);
    };

    (async ()=>{
      const latest = await apiLatest();
      if(latest){
        btnContinue.disabled = false;
        latestInfo.innerHTML = `Último guardado: <strong>${latest.chapter}</strong> — slot <strong>${latest.slot}</strong> — <span class="ok">${latest.updated_at}</span>`;
      } else {
        latestInfo.innerHTML = `<span class="warn">No se han encontrado guardados remotos para este usuario.</span>`;
      }
      btnContinue.onclick = ()=>{
        // Si sabemos el capítulo, vamos directo y que el jugador cargue su slot.
        if(latest && latest.chapter){
          const capNum = (latest.chapter.match(/cap(\d+)/i)?.[1]) || '1';
          openChapter(parseInt(capNum,10));
        } else {
          openChapter(1);
        }
      };
    })();
  </script>
</body>
</html>
