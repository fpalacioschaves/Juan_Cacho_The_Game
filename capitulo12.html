<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<!-- En cada capituloX.html, dentro de <head> -->
<!-- En <head>: -->
<meta name="chapter-id" content="cap012"><!-- ej.: cap01, cap12 -->

<!-- Antes de tu script principal del cap√≠tulo: -->
<!-- Si PHP est√° en la misma carpeta, no pongas nada. Si est√° en /juan_cacho/, puedes forzarlo: -->
<!-- <script>window.__API_BASE__ = '/juan_cacho/';</script> -->
 <script src="core/engine.js"></script>
<script src="remote-saves.js"></script>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Juan Cacho ‚Äî Cap√≠tulo 12 (Desenlace)</title>
<style>
:root{
  --bg:#0f1115;--panel:#171a21;--card:#1f2430;--muted:#aab2c0;--text:#e7ecf3;
  --accent:#7fd1ae;--accent2:#7fb0d1;--danger:#ff6b6b;--ok:#06d6a0;
  --radius:14px;--shadow:0 8px 28px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Arial}
button{cursor:pointer;border:none;background:var(--accent);color:#0d1b14;padding:.6rem 1rem;border-radius:10px;font-weight:600;transition:.15s}
button:hover{filter:brightness(1.06)}
button.ghost{background:transparent;border:1px solid #2a3242;color:var(--text)}
button.secondary{background:var(--accent2)}
.wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
header{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:1rem 1.2rem;background:linear-gradient(180deg,#12161d,#0f1115);border-bottom:1px solid #212836;position:sticky;top:0;z-index:10}
.brand{display:flex;gap:.75rem;align-items:center}
.dot{width:10px;height:10px;border-radius:50%;background:var(--ok);box-shadow:0 0 10px var(--ok)}
h1{margin:0;font-size:1.05rem;color:#d8efe6;letter-spacing:.3px}
.pill{background:#1a2130;border:1px solid #283248;border-radius:999px;padding:.2rem .6rem;font-size:.8rem;color:#cfe0f5}
.toolbar{display:flex;gap:.5rem;align-items:center}
.sel{appearance:none;background:#121722;border:1px solid #263043;color:#d6e3f1;border-radius:10px;padding:.45rem .6rem}
.content{padding:1.1rem;display:grid;gap:1rem}
.scene{display:none;background:var(--panel);border:1px solid #222a3a;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.scene.active{display:grid}
.scene-head{display:flex;align-items:center;justify-content:space-between;padding:1rem;border-bottom:1px solid #242d3e;background:linear-gradient(180deg,#1a202b,#161b24)}
.scene-head h2{margin:0;font-size:1.1rem}
.scene-body{padding:1rem;display:grid;gap:1rem}
.grid{display:grid;gap:1rem}
.cols-2{grid-template-columns:1fr 1fr}
.cols-3{grid-template-columns:1fr 1fr 1fr}
@media (max-width:900px){.cols-2,.cols-3{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid #2a3142;border-radius:12px;padding:1rem;box-shadow:var(--shadow)}
.dialog{display:grid;gap:.5rem}
.line{background:#1a2030;border:1px solid #273145;padding:.6rem .8rem;border-radius:10px}
.choices{display:grid;gap:.5rem}
.hint{color:var(--muted);font-size:.85rem}
.drop{min-height:64px;border:1px dashed #334459;border-radius:12px;background:#121722;padding:.6rem;display:flex;align-items:center;justify-content:space-between;gap:.6rem}
.drop.highlight{outline:2px solid #2f6da1}
.footer{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.6rem 1rem;background:#0f1216;border-top:1px solid #1f2836}
.inventory{display:flex;gap:.5rem;flex-wrap:wrap}
.inv-slot{min-width:44px;min-height:44px;background:#131924;border:1px dashed #2a3242;border-radius:10px;display:flex;align-items:center;justify-content:center;position:relative}
.inv-slot .tag{position:absolute;bottom:-6px;right:-6px;background:#253045;border:1px solid #2c3750;color:#b8c7dc;font-size:.65rem;padding:.05rem .35rem;border-radius:999px}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:20}
.overlay.active{display:flex}
.modal{width:min(900px,92vw);max-height:88vh;overflow:auto;background:var(--panel);border:1px solid #263043;border-radius:16px;box-shadow:var(--shadow);padding:1rem}
.map{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.loc{display:flex;align-items:center;justify-content:space-between;background:#1b2130;border:1px solid #2a3144;border-radius:12px;padding:1rem}
.keypad{display:flex;gap:.4rem;flex-wrap:wrap}
.keypad select{background:#111722;color:#dbe7f6;border:1px solid #2a3448;border-radius:10px;padding:.5rem}
input.text{background:#111722;border:1px solid #2a3448;color:#dbe7f6;border-radius:10px;padding:.55rem .7rem}
.bar{height:10px;border-radius:999px;background:#1a2130;border:1px solid #2a3144;overflow:hidden}
.bar .fill{height:100%;width:0;background:linear-gradient(90deg,#7fb0d1,#7fd1ae)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="dot"></div>
      <h1>Juan Cacho ‚Äî Cap√≠tulo 12</h1>
      <span class="pill" id="statusScene">Escena: ‚Äî</span>
      <span class="pill" id="statusHint">Objetivo: restaurar luz, acceder al PC y enviar evidencias.</span>
    </div>
    <div class="toolbar">
      <select id="langSel" class="sel">
        <option value="es" selected>ES</option>
        <option value="en">EN</option>
      </select>
      <button class="ghost" id="btnPistas">üóíÔ∏è Pistas</button>
      <button class="ghost" id="btnMapa">üó∫Ô∏è Mapa</button>
      <button class="ghost" id="btnSlots">üíæ Guardar/Cargar</button>
      <button class="ghost" id="btnReset">Reiniciar</button>
    </div>
  </header>

  <main class="content">
    <!-- PORTAL -->
    <section class="scene active" data-scene="portal">
      <div class="scene-head">
        <h2>Portal ‚Äî Noche en vela</h2>
        <span class="hint" id="portalHint">El trastero est√° al fondo. Ojo con hacer ruido.</span>
      </div>
      <div class="scene-body grid cols-2">
        <div class="card">
          <h3>Vecino curioso</h3>
          <div class="dialog" id="vecinoDialog">
            <div class="line" id="noiseLine">Se escucha una puerta. Mejor ir r√°pido.</div>
          </div>
          <div class="choices">
            <button class="secondary" id="btnBajarTrastero">Bajar al trastero</button>
            <button class="ghost" id="btnSalirCalle">Salir a la calle</button>
          </div>
          <div style="margin-top:.5rem">
            <div class="hint" id="noiseHint">Tensi√≥n:</div>
            <div class="bar"><div id="noiseFill" class="fill"></div></div>
          </div>
        </div>

        <div class="card">
          <h3>Cuadro del portal</h3>
          <div class="dialog">
            <div class="line">Notas viejas, publicidad y un plano de evacuaci√≥n.</div>
            <div class="line" id="noteLine">Apuntas un tel√©fono de redacci√≥n local.</div>
          </div>
          <div class="choices">
            <button class="ghost" id="btnAnotarTel">Anotar tel√©fono prensa</button>
          </div>
          <p class="hint">Por si necesitas llamar luego desde la calle.</p>
        </div>
      </div>
    </section>

    <!-- TRASTERO -->
    <section class="scene" data-scene="trastero">
      <div class="scene-head">
        <h2>Trastero ‚Äî PC viejo y caja el√©ctrica</h2>
        <span class="hint" id="trasteroHint">Primero luz, luego login, luego USB y enviar.</span>
      </div>
      <div class="scene-body grid cols-2">
        <div class="card">
          <h3>Caja el√©ctrica</h3>
          <div id="dropFuse" class="drop">
            <span id="fuseText">Cable pelado. El diferencial no aguanta.</span>
            <span>‚ö°</span>
          </div>
          <p class="hint" id="fuseHint">Arrastra <b>cinta aislante</b> del inventario.</p>
          <div class="choices" style="margin-top:.6rem">
            <button class="ghost" id="btnBuscarCinta">Buscar cinta en estanter√≠a</button>
          </div>
        </div>

        <div class="card">
          <h3>PC viejo</h3>
          <div class="dialog" id="pcDialog">
            <div class="line" id="pcLine">Pantalla a oscuras. Sin corriente.</div>
          </div>
          <div class="choices keypad" id="loginBox" style="display:none">
            <div style="display:flex;gap:.4rem;flex-wrap:wrap;align-items:center">
              <span class="hint" id="loginHint">Login (5 letras):</span>
              <select id="l1"></select><select id="l2"></select><select id="l3"></select><select id="l4"></select><select id="l5"></select>
              <button class="secondary" id="btnLogin">Entrar</button>
            </div>
            <div style="display:flex;gap:.4rem;flex-wrap:wrap;align-items:center">
              <span class="hint" id="pinHint">o PIN (n√∫meros):</span>
              <input class="text" id="pinInput" placeholder="##### (ej.: 62732)" size="8"/>
              <button class="ghost" id="btnLoginPin">Entrar PIN</button>
            </div>
          </div>
          <div class="drop" id="dropUSB" style="margin-top:.6rem;display:none">
            <span id="usbText">Puerto USB esperando‚Ä¶</span>
            <span>üíª</span>
          </div>
          <div class="choices" id="sendBox" style="display:none;margin-top:.6rem">
            <button class="secondary" id="btnEnviar">Enviar evidencias</button>
          </div>
          <p class="hint" id="pcHint">Secuencia: luz ‚Üí login ‚Üí USB ‚Üí enviar.</p>
        </div>
      </div>
    </section>

    <!-- CALLE -->
    <section class="scene" data-scene="calle">
      <div class="scene-head">
        <h2>Calle ‚Äî Madrugada</h2>
        <span class="hint" id="calleHint">Si lo necesitas, haz una llamada r√°pida.</span>
      </div>
      <div class="scene-body grid cols-2">
        <div class="card">
          <h3>Cabina</h3>
          <div class="dialog" id="callDialog">
            <div class="line">L√≠neas libres a estas horas.</div>
          </div>
          <div class="choices">
            <button class="ghost" id="btnLlamarPrensa">Llamar a redacci√≥n</button>
            <button class="ghost" id="btnLlamarNieves">Llamar a Nieves</button>
          </div>
          <p class="hint">S√≥lo por tranquilidad. El env√≠o se hace desde el PC.</p>
        </div>

        <div class="card">
          <h3>Esquina</h3>
          <div class="dialog">
            <div class="line" id="lookLine">Todo en calma. Alg√∫n coche lejano.</div>
          </div>
          <div class="choices">
            <button class="secondary" id="btnVolverPortal">Volver al portal</button>
          </div>
        </div>
      </div>
    </section>

    <!-- FIN -->
    <section class="scene" data-scene="fin">
      <div class="scene-head">
        <h2>Al amanecer</h2>
        <span class="hint" id="finHint">Se acab√≥ por hoy.</span>
      </div>
      <div class="scene-body">
        <div class="card">
          <div class="dialog" id="finDialog">
            <div class="line">Los archivos vuelan. La palabra <b>MAREA</b> queda grabada en el buz√≥n de salida.</div>
            <div class="line">Nieves manda un mensaje: ‚ÄúGracias. Caf√© cuando pase todo‚Äù.</div>
          </div>
          <p class="hint">Has terminado la primera pasada del juego. Guardado final realizado.</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="inventory" id="inventory"></div>
    <div class="hint" id="hintFooter">Cinta‚ÜíCaja ‚ö° ¬∑ Login: MAREA (o 62732) ¬∑ USB‚ÜíPC ¬∑ Enviar ‚Üí Fin.</div>
  </footer>
</div>

<!-- Overlays -->
<div class="overlay" id="overlayMapa" aria-hidden="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
      <h3 style="margin:0">Mapa</h3>
      <button class="ghost" id="btnCloseMapa">Cerrar</button>
    </div>
    <div class="map">
      <div class="loc"><span>Portal</span><button class="secondary" id="mapPortal">Ir</button></div>
      <div class="loc"><span>Trastero</span><button class="secondary" id="mapTrastero">Ir</button></div>
      <div class="loc"><span>Calle</span><button class="secondary" id="mapCalle">Ir</button></div>
      <div class="loc"><span>Salida (fin)</span><button class="secondary" id="mapFin">Ir</button></div>
    </div>
  </div>
</div>

<div class="overlay" id="overlayPistas" aria-hidden="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
      <h3 style="margin:0">Libretita</h3>
      <button class="ghost" id="btnClosePistas">Cerrar</button>
    </div>
    <div id="pistasBox" class="list"></div>
    <div style="margin-top:.75rem;display:flex;gap:.5rem">
      <input id="pistaInput" placeholder="A√±adir nota‚Ä¶" class="text" style="flex:1"/>
      <button id="btnAddPista">A√±adir</button>
      <button class="ghost" id="btnClearPistas">Vaciar</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlaySlots" aria-hidden="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
      <h3 style="margin:0">Guardado / Carga</h3>
      <button class="ghost" id="btnCloseSlots">Cerrar</button>
    </div>
    <div id="slotsList" class="list"></div>
  </div>
</div>

<script>
/* ==== i18n ==== */
const i18n = {
  lang:'es',
  dict:{
    es:{
      noteSaved:'Progreso guardado.', noteLoaded:'Progreso cargado.',
      gotTape:'Obtienes cinta aislante.', haveTape:'Ya tienes cinta.',
      fuseOk:'A√≠sla hecho. La luz vuelve.', powerOn:'Luz encendida.',
      needTape:'Necesitas cinta.',
      loginReady:'Sistema listo para login.',
      loginOk:'Acceso concedido.',
      loginBad:'Credenciales incorrectas.',
      needPower:'Sin luz no enciende.',
      needLogin:'Primero entra al sistema.',
      needUSB:'Necesitas un USB.',
      usbOk:'USB conectado.',
      sentOk:'Evidencias enviadas. Fin del cap√≠tulo.',
      notedPress:'Apuntas el tel√©fono de la redacci√≥n.',
      callPress:'Redacci√≥n: ‚ÄúLo hemos recibido.‚Äù',
      callNieves:'Nieves: ‚ÄúEstoy bien. Gracias.‚Äù',
      slotEmpty:'(vac√≠o)'
    },
    en:{
      noteSaved:'Progress saved.', noteLoaded:'Progress loaded.',
      gotTape:'You got tape.', haveTape:'You already have tape.',
      fuseOk:'Insulation done. Power back.', powerOn:'Power on.',
      needTape:'You need tape.',
      loginReady:'System ready for login.',
      loginOk:'Access granted.',
      loginBad:'Bad credentials.',
      needPower:'No power.',
      needLogin:'Log in first.',
      needUSB:'You need a USB.',
      usbOk:'USB connected.',
      sentOk:'Evidence sent. Chapter complete.',
      notedPress:'You note the newsroom phone.',
      callPress:'Newsroom: ‚ÄúWe got it.‚Äù',
      callNieves:'Nieves: ‚ÄúI‚Äôm fine. Thank you.‚Äù',
      slotEmpty:'(empty)'
    }
  }
};
const t = k => (i18n.dict[i18n.lang]||{})[k]||k;

/* ==== SFX ==== */
const sfx = {
  ctx:null,
  beep(f=520,d=.07,type='triangle',v=.02){ try{
    this.ctx=this.ctx||new (window.AudioContext||window.webkitAudioContext)();
    if(this.ctx.state!=='running') return;
    const o=this.ctx.createOscillator(), g=this.ctx.createGain();
    o.type=type; o.frequency.value=f; g.gain.value=v; o.connect(g); g.connect(this.ctx.destination);
    o.start(); o.stop(this.ctx.currentTime+d);
  }catch(_){}},
  click(){this.beep(520,.05,'square',.015)}, ok(){this.beep(660,.08,'sine',.03)}, err(){this.beep(220,.12,'sawtooth',.03)}, pick(){this.beep(880,.05,'triangle',.02)}
};

/* ==== Estado ==== */
const flags = {
  tension:0,
  powerFixed:false, powerOn:false,
  haveTape:false,
  loginReady:false, loggedIn:false,
  haveUSB:false, usbIn:false,
  sent:false
};
const pistas=[]; const inventory=[];

/* ==== Persistencia ==== */
const persist={
  save(){ localStorage.setItem('cacho_cap12_auto', JSON.stringify({flags,pistas,inventory,lang:i18n.lang})); ui.note(t('noteSaved')); },
  load(){ const raw=localStorage.getItem('cacho_cap12_auto'); if(!raw) return;
    try{
      const d=JSON.parse(raw)||{};
      Object.assign(flags,d.flags||{});
      pistas.splice(0,pistas.length,...(d.pistas||[]));
      inventory.splice(0,inventory.length,...(d.inventory||[]));
      if(d.lang) i18n.lang=d.lang;
      ui.refreshInventory(); ui.applyLang(); ui.renderPistas();
      nav.go(nav.current||'portal'); bindAreas(); refreshAll(); sfx.ok(); ui.note(t('noteLoaded'));
    }catch(_){}
  },
  saveSlot(n){ localStorage.setItem('cacho_cap12_slot_'+n, JSON.stringify({flags,pistas,inventory,lang:i18n.lang})); ui.renderSlots(); sfx.ok(); ui.note(t('noteSaved')); },
  loadSlot(n){
    const raw=localStorage.getItem('cacho_cap12_slot_'+n); if(!raw) return;
    const d=JSON.parse(raw)||{};
    Object.assign(flags,d.flags||{});
    pistas.splice(0,pistas.length,...(d.pistas||[]));
    inventory.splice(0,inventory.length,...(d.inventory||[]));
    i18n.lang=d.lang||'es';
    ui.refreshInventory(); ui.applyLang(); ui.renderPistas();
    nav.go(nav.current||'portal'); bindAreas(); refreshAll(); sfx.ok(); ui.note(t('noteLoaded'));
  },
  reset(){ localStorage.removeItem('cacho_cap12_auto'); location.reload(); }
};

/* ==== UI ==== */
const ui={
  say(id,html){ const el=document.getElementById(id); if(el) el.innerHTML=html; },
  note(msg){ const el=document.getElementById('statusHint'); if(el) el.textContent=msg; },
  setScene(name){ const el=document.getElementById('statusScene'); if(el) el.textContent='Escena: '+name; },
  refreshInventory(){
    const box=document.getElementById('inventory'); if(!box) return; box.innerHTML='';
    inventory.forEach(it=>{
      const slot=document.createElement('div'); slot.className='inv-slot'; slot.dataset.item=it.id; slot.title=it.name; slot.draggable=true;
      slot.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', it.id); });
      slot.innerHTML=`<span>${it.icon||'üéí'}</span><span class="tag">${it.tag||''}</span>`;
      box.appendChild(slot);
    });
  },
  addItem(it){ if(!inventory.find(x=>x.id===it.id)){ inventory.push(it); this.refreshInventory(); persist.save(); sfx.pick(); } },
  removeItem(id){ const i=inventory.findIndex(x=>x.id===id); if(i>=0){ inventory.splice(i,1); this.refreshInventory(); persist.save(); } },
  toggleMapa(show){ const o=document.getElementById('overlayMapa'); o.classList.toggle('active',!!show); o.setAttribute('aria-hidden',(!show).toString()); },
  togglePistas(show){ const o=document.getElementById('overlayPistas'); o.classList.toggle('active',!!show); o.setAttribute('aria-hidden',(!show).toString()); this.renderPistas(); },
  toggleSlots(show){ const o=document.getElementById('overlaySlots'); if(show) this.renderSlots(); o.classList.toggle('active',!!show); o.setAttribute('aria-hidden',(!show).toString()); },
  renderPistas(){
    const box=document.getElementById('pistasBox'); if(!box) return; box.innerHTML='';
    if(!pistas.length){ box.innerHTML = `<div class="hint">${i18n.lang==='es'?'Sin notas por ahora.':'No notes yet.'}</div>`; return; }
    pistas.slice(-20).forEach((p,i)=>{ const row=document.createElement('div'); row.className='item';
      const span=document.createElement('span'); span.textContent=p;
      const b=document.createElement('button'); b.className='ghost'; b.textContent=i18n.lang==='es'?'Borrar':'Delete';
      b.addEventListener('click', ()=>{ pistas.splice(i,1); ui.renderPistas(); persist.save(); });
      row.appendChild(span); row.appendChild(b); box.appendChild(row);
    });
  },
  renderSlots(){
    const box=document.getElementById('slotsList'); if(!box) return; box.innerHTML='';
    [1,2,3].forEach(n=>{
      const raw=localStorage.getItem('cacho_cap12_slot_'+n);
      const row=document.createElement('div'); row.className='item';
      const label=document.createElement('span'); label.innerHTML=`<b>Slot ${n}</b> ‚Äî ${raw?'OK':t('slotEmpty')}`;
      const act=document.createElement('span');
      const s=document.createElement('button'); s.className='secondary'; s.textContent=i18n.lang==='es'?'Guardar':'Save';
      const l=document.createElement('button'); l.className='ghost'; l.textContent=i18n.lang==='es'?'Cargar':'Load';
      s.addEventListener('click', ()=>persist.saveSlot(n));
      l.addEventListener('click', ()=>persist.loadSlot(n));
      act.appendChild(s); act.appendChild(l);
      row.appendChild(label); row.appendChild(act);
      box.appendChild(row);
    });
  },
  applyLang(){
    document.getElementById('langSel').value=i18n.lang;
    document.getElementById('portalHint').textContent = i18n.lang==='es'?'El trastero est√° al fondo. Ojo con hacer ruido.':'Storage room is in the back. Mind the noise.';
    document.getElementById('noiseHint').textContent = i18n.lang==='es'?'Tensi√≥n:':'Tension:';
    document.getElementById('trasteroHint').textContent = i18n.lang==='es'?'Primero luz, luego login, luego USB y enviar.':'First power, then login, then USB and send.';
    document.getElementById('fuseHint').textContent = i18n.lang==='es'?'Arrastra cinta aislante del inventario.':'Drag tape from inventory.';
    document.getElementById('pcHint').textContent = i18n.lang==='es'?'Secuencia: luz ‚Üí login ‚Üí USB ‚Üí enviar.':'Sequence: power ‚Üí login ‚Üí USB ‚Üí send.';
    document.getElementById('loginHint').textContent = i18n.lang==='es'?'Login (5 letras):':'Login (5 letters):';
    document.getElementById('pinHint').textContent = i18n.lang==='es'?'o PIN (n√∫meros):':'or PIN (numbers):';
    document.getElementById('calleHint').textContent = i18n.lang==='es'?'Si lo necesitas, haz una llamada r√°pida.':'Make a quick call if needed.';
    document.getElementById('finHint').textContent = i18n.lang==='es'?'Se acab√≥ por hoy.':'That‚Äôs it for tonight.';
  }
};

/* ==== Navegaci√≥n ==== */
const sceneNames={portal:'Portal', trastero:'Trastero', calle:'Calle', fin:'(Fin)'};
const nav={
  current:'portal',
  go(scene){
    document.querySelectorAll('.scene').forEach(s=>s.classList.remove('active'));
    const el=document.querySelector(`.scene[data-scene="${scene}"]`); if(el){ el.classList.add('active'); this.current=scene; ui.setScene(sceneNames[scene]||scene); persist.save(); }
    if(scene==='trastero') login.populate();
  },
  finish(){
    if(!flags.sent){ ui.note(i18n.lang==='es'?'Env√≠a primero las evidencias.':'Send the evidence first.'); sfx.err(); return; }
    this.go('fin'); sfx.ok(); persist.save();
  }
};

/* ==== Acciones generales ==== */
const actions={ note(text){ if(!pistas.includes(text)){ pistas.push(text); ui.renderPistas(); persist.save(); sfx.click(); } } };

/* ==== Portal ==== */
const portal={
  tension(n){ flags.tension=Math.max(0,Math.min(100, flags.tension+n)); const f=document.getElementById('noiseFill'); if(f) f.style.width=flags.tension+'%';
    const line=document.getElementById('noiseLine'); if(!line) return;
    if(flags.tension>=70) line.textContent = i18n.lang==='es'?'Se enciende una luz en el rellano.':'A light turns on upstairs.';
    else if(flags.tension>=40) line.textContent = i18n.lang==='es'?'Se oyen pasos.':'You hear steps.';
    else line.textContent = i18n.lang==='es'?'Se escucha una puerta. Mejor ir r√°pido.':'A door creaks. Better move.';
  },
  notePress(){ actions.note(i18n.lang==='es'?'Tel√©fono redacci√≥n anotado.':'Newsroom phone noted.'); ui.note(t('notedPress')); sfx.click(); }
};

/* ==== Trastero (fuse + pc) ==== */
const fusebox={
  bind(){
    const dz=document.getElementById('dropFuse');
    dz.ondragover = e=>{ e.preventDefault(); dz.classList.add('highlight'); };
    dz.ondragleave = ()=>dz.classList.remove('highlight');
    dz.ondrop = e=>{
      e.preventDefault(); dz.classList.remove('highlight');
      const id=e.dataTransfer.getData('text/plain');
      if(id==='cinta'){
        if(!flags.powerFixed){
          flags.powerFixed=true; ui.say('fuseText', i18n.lang==='es'?'Aislado.':'Insulated.'); ui.note(t('fuseOk')); sfx.ok();
          setTimeout(()=>{ flags.powerOn=true; ui.say('pcLine', i18n.lang==='es'?'Pantalla con parpadeo. BIOS antigua.':'Screen flickers. Old BIOS.');
            ui.note(t('powerOn')); sfx.click(); document.getElementById('loginBox').style.display='block'; }, 300);
        }
      }else{
        ui.note(t('needTape')); sfx.err();
      }
    };
  },
  searchTape(){
    if(flags.haveTape){ ui.note(t('haveTape')); return; }
    flags.haveTape=true; ui.addItem({id:'cinta',name:i18n.lang==='es'?'Cinta aislante':'Electrical tape',icon:'ü©π'}); ui.note(t('gotTape'));
  }
};

const login={
  letters:'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''),
  codeLetters:['M','A','R','E','A'],
  codePin:'62732',
  populate(){
    ['l1','l2','l3','l4','l5'].forEach((id,i)=>{
      const s=document.getElementById(id); if(!s) return; s.innerHTML='';
      this.letters.forEach(L=>{ const o=document.createElement('option'); o.value=L; o.textContent=L; s.appendChild(o); });
      const idx=this.letters.indexOf(this.codeLetters[i]); if(idx>=0) s.selectedIndex=idx;
    });
    if(flags.powerOn){ document.getElementById('loginBox').style.display='block'; ui.note(t('loginReady')); }
  },
  tryLetters(){
    if(!flags.powerOn){ ui.note(t('needPower')); sfx.err(); return; }
    const v=['l1','l2','l3','l4','l5'].map(id=>document.getElementById(id).value.toUpperCase());
    if(v.join('')===this.codeLetters.join('')) this.onLoginOk(); else { ui.note(t('loginBad')); sfx.err(); }
  },
  tryPin(){
    if(!flags.powerOn){ ui.note(t('needPower')); sfx.err(); return; }
    const pin=(document.getElementById('pinInput').value||'').trim();
    if(pin===this.codePin) this.onLoginOk(); else { ui.note(t('loginBad')); sfx.err(); }
  },
  onLoginOk(){
    if(flags.loggedIn) return;
    flags.loggedIn=true; ui.note(t('loginOk')); sfx.ok();
    document.getElementById('dropUSB').style.display='flex';
    ui.say('pcDialog', `<div class="line">${i18n.lang==='es'?'Escritorio antediluviano.':'Prehistoric desktop.'}</div><div class="line">${i18n.lang==='es'?'Abres el programa de env√≠o.':'You open the sending tool.'}</div>`);
  }
};

const pc={
  bindUSB(){
    const dz=document.getElementById('dropUSB');
    dz.ondragover = e=>{ e.preventDefault(); dz.classList.add('highlight'); };
    dz.ondragleave = ()=>dz.classList.remove('highlight');
    dz.ondrop = e=>{
      e.preventDefault(); dz.classList.remove('highlight');
      const id=e.dataTransfer.getData('text/plain');
      if(id==='usb'){
        if(!flags.loggedIn){ ui.note(t('needLogin')); sfx.err(); return; }
        if(!flags.usbIn){ flags.usbIn=true; ui.say('usbText', i18n.lang==='es'?'USB montado.':'USB mounted.'); ui.note(t('usbOk')); sfx.ok();
          document.getElementById('sendBox').style.display='grid';
        }
      }else{
        ui.note(t('needUSB')); sfx.err();
      }
    };
  },
  send(){
    if(!(flags.loggedIn && flags.usbIn)){ ui.note(i18n.lang==='es'?'Falta login o USB.':'Missing login or USB.'); sfx.err(); return; }
    if(flags.sent) return;
    flags.sent=true; sfx.ok();
    actions.note(i18n.lang==='es'?'Enviado a prensa.':'Sent to press.');
    ui.note(t('sentOk')); nav.finish(); persist.save();
  }
};

/* ==== Calle ==== */
const street={
  pressCall(){ actions.note(i18n.lang==='es'?'Prensa avisada.':'Press warned.'); ui.say('callDialog', `<div class="line">${t('callPress')}</div>`); sfx.click(); },
  nievesCall(){ actions.note(i18n.lang==='es'?'Hablas con Nieves.':'You speak with Nieves.'); ui.say('callDialog', `<div class="line">${t('callNieves')}</div>`); sfx.click(); }
};

/* ==== Bindings ==== */
function bindUI(){
  // Toolbar
  document.getElementById('btnMapa').addEventListener('click', ()=>ui.toggleMapa(true));
  document.getElementById('btnPistas').addEventListener('click', ()=>ui.togglePistas(true));
  document.getElementById('btnSlots').addEventListener('click', ()=>ui.toggleSlots(true));
  document.getElementById('btnReset').addEventListener('click', ()=>persist.reset());
  document.getElementById('langSel').addEventListener('change', e=>{ i18n.lang=e.target.value; ui.applyLang(); persist.save(); sfx.click(); });
  // Overlays
  document.getElementById('btnCloseMapa').addEventListener('click', ()=>ui.toggleMapa(false));
  document.getElementById('btnClosePistas').addEventListener('click', ()=>ui.togglePistas(false));
  document.getElementById('btnCloseSlots').addEventListener('click', ()=>ui.toggleSlots(false));
  // Mapa
  document.getElementById('mapPortal').addEventListener('click', ()=>{ ui.toggleMapa(false); nav.go('portal'); });
  document.getElementById('mapTrastero').addEventListener('click', ()=>{ ui.toggleMapa(false); nav.go('trastero'); });
  document.getElementById('mapCalle').addEventListener('click', ()=>{ ui.toggleMapa(false); nav.go('calle'); });
  document.getElementById('mapFin').addEventListener('click', ()=>{ ui.toggleMapa(false); nav.finish(); });
  // Portal
  document.getElementById('btnBajarTrastero').addEventListener('click', ()=>{ portal.tension(10); nav.go('trastero'); });
  document.getElementById('btnSalirCalle').addEventListener('click', ()=>{ portal.tension(5); nav.go('calle'); });
  document.getElementById('btnAnotarTel').addEventListener('click', ()=>portal.notePress());
  // Trastero
  document.getElementById('btnBuscarCinta').addEventListener('click', ()=>fusebox.searchTape());
  document.getElementById('btnLogin').addEventListener('click', ()=>login.tryLetters());
  document.getElementById('btnLoginPin').addEventListener('click', ()=>login.tryPin());
  document.getElementById('btnEnviar').addEventListener('click', ()=>pc.send());
  // Calle
  document.getElementById('btnLlamarPrensa').addEventListener('click', ()=>street.pressCall());
  document.getElementById('btnLlamarNieves').addEventListener('click', ()=>street.nievesCall());
  document.getElementById('btnVolverPortal').addEventListener('click', ()=>nav.go('portal'));
}
function bindAreas(){ fusebox.bind(); pc.bindUSB(); }

/* ==== Refresh ==== */
function refreshAll(){
  // tension bar
  portal.tension(0);
  // power state
  if(flags.powerFixed){ ui.say('fuseText', i18n.lang==='es'?'Aislado.':'Insulated.'); }
  if(flags.powerOn){
    ui.say('pcLine', i18n.lang==='es'?'Pantalla con parpadeo. BIOS antigua.':'Screen flickers. Old BIOS.');
    document.getElementById('loginBox').style.display='block';
  }
  if(flags.loggedIn){
    ui.say('pcDialog', `<div class="line">${i18n.lang==='es'?'Escritorio antediluviano.':'Prehistoric desktop.'}</div><div class="line">${i18n.lang==='es'?'Abres el programa de env√≠o.':'You open the sending tool.'}</div>`);
    document.getElementById('dropUSB').style.display='flex';
  }
  if(flags.usbIn){
    ui.say('usbText', i18n.lang==='es'?'USB montado.':'USB mounted.');
    document.getElementById('sendBox').style.display='grid';
  }
  // inventory sync (por si import√≥)
  if(flags.haveTape && !inventory.find(i=>i.id==='cinta')) ui.addItem({id:'cinta',name:i18n.lang==='es'?'Cinta aislante':'Electrical tape',icon:'ü©π'});
  if(flags.haveUSB && !inventory.find(i=>i.id==='usb')) ui.addItem({id:'usb',name:'USB',icon:'üíæ'});
}

/* ==== Audio unlock ==== */
window.addEventListener('pointerdown', async ()=>{ try{
  sfx.ctx=sfx.ctx||new (window.AudioContext||window.webkitAudioContext)();
  if(sfx.ctx.state==='suspended') await sfx.ctx.resume();
}catch(_){}} , {once:true});

/* ==== Import desde Cap. 11 si no hay guardado local ==== */
function importFromCap11(){
  if(localStorage.getItem('cacho_cap12_auto')) return;
  try{
    const d=JSON.parse(localStorage.getItem('cacho_cap11_auto')||'{}');
    (d.inventory||[]).forEach(it=>{
      if(!inventory.find(x=>x.id===it.id)) ui.addItem(it);
      if(it.id==='cinta') flags.haveTape=true;
      if(it.id==='usb') flags.haveUSB=true;
    });
    (d.pistas||[]).forEach(p=>{ if(!pistas.includes(p)) pistas.push(p); });
  }catch(_){}
}

/* ==== INIT ==== */
function populateLoginSelectors(){
  login.populate();
}
function ready(){
  ui.applyLang();
  ui.setScene('Portal');
  ui.refreshInventory();
  ui.renderPistas();
  bindUI();
  bindAreas();
  importFromCap11();
  persist.load(); // si hay guardado del 12, pisa lo anterior
  populateLoginSelectors();
  refreshAll();
}
ready();

/* ==== Expose debug ==== */
window.flags=flags; window.ui=ui; window.nav=nav; window.actions=actions;
window.portal=portal; window.fusebox=fusebox; window.login=login; window.pc=pc; window.street=street; window.persist=persist;
</script>
</body>
</html>
